---
// src/components/RegistrationFlow.astro
const { initialEmail = "" } = Astro.props;
---

<div class="registration-container" id="reg-flow">
    <div id="step-1" class="step">
        <h3>Erstelle dein Profil</h3>
        <p class="subline">Damit Käufer wissen, mit wem sie es zu tun haben.</p>
        
        <form id="details-form">
            <div class="input-row">
                <input type="text" id="vorname" placeholder="Vorname" required />
                <input type="text" id="nachname" placeholder="Nachname" required />
            </div>
            <input type="text" id="nickname" placeholder="Nickname (wird öffentlich angezeigt)" required />
            <input type="email" id="reg-email" value={initialEmail} placeholder="E-Mail Adresse" required />
            
            <button type="submit" class="btn-primary">Code anfordern</button>
        </form>
    </div>

    <div id="step-2" class="step hidden">
        <h3>Prüfe dein Postfach</h3>
        <p>Wir haben einen Code an <strong id="display-email"></strong> gesendet.</p>
        
        <input type="text" id="otp-code" placeholder="6-stelliger Code" maxlength="6" />
        <button id="verify-btn" class="btn-primary">Profil bestätigen & Einloggen</button>
        <button id="back-btn" class="btn-link">Zurück</button>
    </div>
</div>

<script>
    import { supabase } from '../lib/supabaseClient'; // Stelle sicher, dass der Client hier verfügbar ist

    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const detailsForm = document.getElementById('details-form');
    const verifyBtn = document.getElementById('verify-btn');

    let userData = {};

    // PHASE 1: Formular absenden & OTP anfordern
    detailsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        userData = {
            vorname: document.getElementById('vorname').value,
            nachname: document.getElementById('nachname').value,
            nickname: document.getElementById('nickname').value,
            email: document.getElementById('reg-email').value
        };

        const { error } = await supabase.auth.signInWithOtp({
            email: userData.email,
        });

        if (error) {
            alert("Fehler: " + error.message);
        } else {
            document.getElementById('display-email').innerText = userData.email;
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
        }
    });

    // PHASE 2: OTP verifizieren & Profil in DB anlegen
    verifyBtn.addEventListener('click', async () => {
        const token = document.getElementById('otp-code').value;

        const { data, error } = await supabase.auth.verifyOtp({
            email: userData.email,
            token,
            type: 'signup' // oder 'magiclink'
        });

        if (error) {
            alert("Falscher Code oder abgelaufen.");
        } else if (data.user) {
            // JETZT das Profil in der Datenbank anlegen/aktualisieren
            const { error: profileError } = await supabase
                .from('profiles')
                .upsert({
                    id: data.user.id,
                    nickname: userData.nickname,
                    // falls du Vorname/Nachname in die Table aufnimmst:
                    // first_name: userData.vorname,
                    // last_name: userData.nachname
                });

            if (profileError) {
                console.error("Profil-Fehler:", profileError);
            }
            
            // Erfolg! Weiterleitung zum Dashboard oder Inserat
            window.location.href = '/dashboard?msg=welcome';
        }
    });
</script>

<style>
    .hidden { display: none; }
    .registration-container {
        background: #1a1a1a;
        padding: 40px;
        border-radius: 24px;
        border: 5px solid rgba(255,255,255,0.05);
        max-width: 500px;
        margin: 0 auto;
    }
    .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
    input { 
        width: 100%; padding: 15px; background: #222; border: 1px solid #444; 
        color: white; border-radius: 12px; margin-bottom: 15px;
    }
    .btn-link { background: none; border: none; color: #888; cursor: pointer; margin-top: 10px; }
</style>