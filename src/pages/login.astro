---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Anmelden - Startplatzbörse">
    <main class="login-container">
        <div class="login-card">
            <div class="login-header">
                <span class="badge" id="top-badge">Sicherer Zugang</span>
                <h1 id="main-title">Willkommen zurück</h1>
                <p id="status-text">Gib deine E-Mail ein, um dich anzumelden oder ein Konto zu erstellen.</p>
            </div>

            <div id="step-email">
                <div class="input-group">
                    <label>E-Mail Adresse</label>
                    <input type="email" id="email" placeholder="name@beispiel.de" required maxlength="50" />
                </div>
                <button id="btn-send-code" class="btn-primary">Code anfordern</button>
            </div>

            <div id="step-code" style="display: none;">
                <div class="input-group">
                    <label>6-stelliger Code</label>
                    <input type="text" id="otp-code" placeholder="123456" maxlength="6" autocomplete="one-time-code" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                </div>
                <button id="btn-verify" class="btn-primary">Anmelden & Weiter</button>
                <button id="btn-back" class="btn-link">Andere E-Mail nutzen</button>
            </div>

            <div id="step-register" style="display: none;">
                <div class="input-group">
                    <label>Vorname</label>
                    <input type="text" id="vorname" placeholder="Dein Vorname" maxlength="30" />
                </div>
                <div class="input-group">
                    <label>Nachname</label>
                    <input type="text" id="nachname" placeholder="Dein Nachname" maxlength="30" />
                </div>
                <div class="input-group">
                    <label>Nickname</label>
                    <input type="text" id="nickname" placeholder="3-20 Zeichen" maxlength="20" />
                </div>
                <button id="btn-complete-profile" class="btn-primary">Profil speichern & Starten</button>
            </div>
            
            <div id="error-msg" style="color: #ff3b30; font-size: 0.85rem; margin-top: 15px; display: none; text-align: center; font-weight: 600; background: rgba(255, 59, 48, 0.1); padding: 10px; border-radius: 8px; line-height: 1.4;"></div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const emailInput = document.getElementById('email') as HTMLInputElement;
    const otpInput = document.getElementById('otp-code') as HTMLInputElement;
    const statusText = document.getElementById('status-text');
    const mainTitle = document.getElementById('main-title');
    const stepEmail = document.getElementById('step-email');
    const stepCode = document.getElementById('step-code');
    const stepRegister = document.getElementById('step-register');
    const errorDisplay = document.getElementById('error-msg');

    function showError(message: string) {
        if (errorDisplay) {
            errorDisplay.innerText = message;
            errorDisplay.style.display = 'block';
        }
    }

    function hideError() {
        if (errorDisplay) errorDisplay.style.display = 'none';
    }

    // 1. CODE ANFORDERN
    document.getElementById('btn-send-code')?.addEventListener('click', async (e) => {
        hideError();
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!email) return showError("Bitte E-Mail Adresse eingeben.");
        if (!emailRegex.test(email)) return showError("Das ist keine gültige E-Mail Adresse.");

        const btn = e.target as HTMLButtonElement;
        btn.innerText = "Sende...";
        btn.disabled = true;

        const { error } = await supabase.auth.signInWithOtp({ email });

        if (error) {
            showError("Fehler: " + error.message);
            btn.innerText = "Code anfordern";
            btn.disabled = false;
        } else {
            if(stepEmail) stepEmail.style.display = 'none';
            if(stepCode) stepCode.style.display = 'block';
            if(statusText) statusText.innerText = `Code gesendet an: ${email}`;
            otpInput.focus();
        }
    });

    // 2. OTP VERIFIZIEREN
    document.getElementById('btn-verify')?.addEventListener('click', async (e) => {
        hideError();
        const email = emailInput.value.trim();
        const token = otpInput.value.trim();

        if (token.length < 6) return showError("Der Code muss 6-stellig sein.");

        const btn = e.target as HTMLButtonElement;
        btn.innerText = "Prüfe...";
        btn.disabled = true;

        let { data: authData, error: authError } = await supabase.auth.verifyOtp({
            email, token, type: 'email'
        });

        if (authError) {
            const signupRes = await supabase.auth.verifyOtp({
                email, token, type: 'signup'
            });
            authData = signupRes.data;
            authError = signupRes.error;
        }

        if (authError || !authData.user) {
            showError("Code ungültig oder abgelaufen.");
            btn.innerText = "Anmelden & Weiter";
            btn.disabled = false;
        } else {
            const { data: profile } = await supabase
                .from('profiles')
                .select('has_completed_onboarding')
                .eq('id', authData.user.id)
                .single();

            if (profile?.has_completed_onboarding) {
                const urlParams = new URLSearchParams(window.location.search);
                window.location.href = urlParams.get('redirect') || "/dashboard";
            } else {
                if(stepCode) stepCode.style.display = 'none';
                if(stepRegister) stepRegister.style.display = 'block';
                if(mainTitle) mainTitle.innerText = "Willkommen!";
                if(statusText) statusText.innerText = "Erstelle kurz dein Profil.";
            }
        }
    });

    // 3. PROFIL SPEICHERN
    document.getElementById('btn-complete-profile')?.addEventListener('click', async (e) => {
        hideError();
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return window.location.reload();

        const nickname = (document.getElementById('nickname') as HTMLInputElement).value.trim();
        const first_name = (document.getElementById('vorname') as HTMLInputElement).value.trim();
        const last_name = (document.getElementById('nachname') as HTMLInputElement).value.trim();

        // VALIDIERUNG
        const nicknameRegex = /^[a-zA-Z0-9_]{3,20}$/; 
        const nameRegex = /^[a-zA-ZÀ-ÿ\s\-]{2,30}$/;

        if (!nameRegex.test(first_name)) return showError("Vorname ungültig (Nur Buchstaben, 2-30 Zeichen).");
        if (!nameRegex.test(last_name)) return showError("Nachname ungültig (Nur Buchstaben, 2-30 Zeichen).");
        if (!nicknameRegex.test(nickname)) return showError("Nickname ungültig: 3-20 Zeichen, nur Buchstaben, Zahlen & Unterstrich.");

        const btn = e.target as HTMLButtonElement;
        btn.innerText = "Speichere...";
        btn.disabled = true;

        const { error } = await supabase.from('profiles').upsert({
            id: session.user.id,
            nickname,
            first_name,
            last_name,
            registered_email: session.user.email,
            has_completed_onboarding: true
        });

        if (error) {
            if (error.code === '23505') {
                showError("Dieser Nickname ist bereits vergeben.");
            } else {
                showError("Fehler: " + error.message);
            }
            btn.innerText = "Profil speichern & Starten";
            btn.disabled = false;
        } else {
            window.location.href = "/dashboard";
        }
    });

    document.getElementById('btn-back')?.addEventListener('click', () => {
        hideError();
        if(stepEmail) stepEmail.style.display = 'block';
        if(stepCode) stepCode.style.display = 'none';
        if(statusText) statusText.innerText = "Gib deine E-Mail ein, um dich anzumelden.";
    });
</script>

<style>
    :root { --cyan: #00bcd4; --bg: #323232; }
    
    .login-container {
        min-height: 100vh;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 120px 20px 60px;
        color: white;
        font-family: system-ui, sans-serif;
    }

    .login-card {
        background: #111;
        width: 100%;
        max-width: 400px;
        padding: 40px;
        border-radius: 24px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .login-header { text-align: center; margin-bottom: 30px; }
    .badge { color: var(--cyan); font-weight: 900; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 10px; display: block; }
    h1 { font-size: 2rem; font-weight: 900; margin-bottom: 10px; color: white; }
    p { color: #888; font-size: 0.9rem; line-height: 1.5; }

    .input-group { margin-bottom: 20px; text-align: left; }
    label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
    input {
        width: 100%;
        background: #000;
        border: 1px solid #333;
        padding: 15px;
        border-radius: 12px;
        color: white;
        font-size: 1.1rem;
        transition: 0.3s;
        box-sizing: border-box;
    }
    input:focus { border-color: var(--cyan); outline: none; }
    input#otp-code { text-align: center; font-weight: 700; letter-spacing: 4px; font-size: 1.5rem; }

    .btn-primary {
        width: 100%;
        background: var(--cyan);
        color: black;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-weight: 900;
        cursor: pointer;
        transition: 0.3s;
        font-size: 1rem;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 188, 212, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-link {
        background: none;
        border: none;
        color: #666;
        margin-top: 20px;
        cursor: pointer;
        font-size: 0.8rem;
        width: 100%;
        text-decoration: underline;
    }

    #step-email, #step-code, #step-register { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>