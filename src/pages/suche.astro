---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Suche | startplatzboerse.com">
    <main class="page-base">
        
        <div class="sticky-unit">
            <div class="unit-inner">
                <div class="action-bar">
                    <div class="search-wrap">
                        <svg class="icon-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path>
                        </svg>
                        <input type="text" id="main-search" placeholder="Event suchen..." autocomplete="off" />
                    </div>
                    
                    <button id="filter-toggle" class="t-btn">
    <svg 
        width="24" 
        height="24" 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        stroke-width="2.5" 
        stroke-linecap="round" 
        stroke-linejoin="round"
        style="display: block; width: 24px; height: 24px;"
    >
        <line x1="4" y1="21" x2="4" y2="14"></line>
        <line x1="4" y1="10" x2="4" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12" y2="3"></line>
        <line x1="20" y1="21" x2="20" y2="16"></line>
        <line x1="20" y1="12" x2="20" y2="3"></line>
        <line x1="1" y1="14" x2="7" y2="14"></line>
        <line x1="9" y1="8" x2="15" y2="8"></line>
        <line x1="17" y1="16" x2="23" y2="16"></line>
    </svg>
</button>
                </div>

                <div id="filter-drawer" class="drawer">
                    <div class="drawer-content">
                        
                        <div class="f-section">
                            <label>Sportart</label>
                            <div class="p-scroll">
                                <button class="pill active" data-cat="">Alle</button>
                                <button class="pill" data-cat="Radrennen">Radrennen</button>
                                <button class="pill" data-cat="Laufen">Laufen</button>
                                <button class="pill" data-cat="Triathlon">Triathlon</button>
                                <button class="pill" data-cat="Hyrox">Hyrox</button>
                            </div>
                        </div>

                        <div class="f-section">
                            <label>Standort & Umkreis</label>
                            <div class="loc-row">
                                <input type="text" id="city-input" placeholder="Stadt..." />
                                <select id="range-select">
                                    <option value="0">Ort</option>
                                    <option value="50">+50km</option>
                                    <option value="100">+100km</option>
                                </select>
                            </div>
                        </div>

                        <div class="f-section grid-2">
                            <div>
                                <label>Preis bis (€)</label>
                                <input type="number" id="max-price" placeholder="Max" />
                            </div>
                            <div>
                                <label>Distanz (km)</label>
                                <input type="number" id="max-dist" placeholder="Max" />
                            </div>
                        </div>

                        <div class="f-actions">
                            <button id="reset-btn" class="r-btn">Zurücksetzen</button>
                            <button id="apply-btn" class="a-btn">Anwenden</button>
                        </div>
                    </div>
                </div>

                <div class="status-line">
                    <span id="res-count">Events werden geladen...</span>
                </div>
            </div>
        </div>

        <section class="feed">
            <div id="results-grid" class="grid-layout">
                </div>
        </section>

    </main>
    <Footer />
</Layout>

<style is:global>
    :root {
        --cyan: #00bcd4;
        --header-h: 80px;
        --filter-h: 80px;
        --bg: #050505;
    }

    /* Damit der Content nicht unter den fixierten Filtern verschwindet */
    .page-base {
        background: var(--bg);
        min-height: 100dvh;
        padding-top: calc(var(--header-h) + var(--filter-h) + 30px);
    }

    /* FIXIERTER BLOCK UNTER LOGO */
    .sticky-unit {
        position: fixed;
        top: var(--header-h);
        left: 0;
        right: 0;
        z-index: 990;
        background: rgba(5, 5, 5, 0.96);
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 12px 0;
    }

    .unit-inner {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .action-bar {
        display: flex;
        gap: 10px;
    }

    .search-wrap {
        flex: 1;
        background: #121212;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 14px;
        display: flex;
        align-items: center;
        padding: 0 12px;
    }

    .icon-s { width: 18px; color: var(--cyan); }
    #main-search {
        background: transparent; border: none; color: white;
        padding: 12px 8px; font-size: 16px; width: 100%; outline: none;
    }

    .t-btn {
        background: #121212; border: 1px solid rgba(255,255,255,0.1);
        color: white; border-radius: 14px; width: 48px; height: 48px;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .t-btn.active { background: var(--cyan); color: black; }

    /* DRAWER */
    .drawer {
        max-height: 0; overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
    }
    .drawer.open {
        max-height: 500px; opacity: 1; padding-top: 20px;
    }

    .f-section { margin-bottom: 18px; }
    .f-section label {
        display: block; color: #444; font-size: 10px;
        text-transform: uppercase; font-weight: 900; margin-bottom: 8px;
    }

    .p-scroll { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
    .pill {
        background: #1a1a1a; border: 1px solid rgba(255,255,255,0.05); color: #666;
        padding: 8px 16px; border-radius: 100px; font-size: 12px; font-weight: 700; white-space: nowrap; cursor: pointer;
    }
    .pill.active { background: var(--cyan); color: black; }

    .loc-row, .grid-2 { display: flex; gap: 8px; }
    .grid-2 > div { flex: 1; }

    input[type="text"], input[type="number"], select {
        background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08);
        color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; font-size: 16px;
    }

    .f-actions {
        display: flex; justify-content: space-between; align-items: center;
        padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .a-btn { background: var(--cyan); color: black; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; }
    .r-btn { background: transparent; border: none; color: #ff5252; font-size: 13px; font-weight: 700; cursor: pointer; }

    .status-line { text-align: center; margin-top: 10px; }
    #res-count { font-size: 9px; color: #333; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; }

    /* RESULTS GRID */
    .feed { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 0 15px 100px; }
    .grid-layout {
        display: grid; grid-template-columns: 1fr; gap: 20px;
        width: 100%; max-width: 900px;
    }
    @media (min-width: 768px) { .grid-layout { grid-template-columns: 1fr 1fr; } }

    /* CARDS */
    .card-link { text-decoration: none; display: block; transition: 0.3s; }
    .card-link:hover { transform: translateY(-5px); }

    .e-card {
        background: #111; padding: 22px; border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.08); color: white;
    }
    .c-top { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .c-tag { color: var(--cyan); font-weight: 900; font-size: 10px; text-transform: uppercase; }
    h3 { margin: 8px 0; font-size: 1.3rem; font-weight: 900; line-height: 1.1; }
    .c-bottom { display: flex; justify-content: space-between; align-items: flex-end; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
    .val { color: var(--cyan); font-size: 1.8rem; font-weight: 900; }
    /* --- 1. ABSTANDS-FIX FÜR DESKTOP --- */
@media (min-width: 1024px) {
    .page-base {
        /* Erhöhter Puffer, damit es luftiger wirkt */
        padding-top: calc(var(--header-h) + var(--filter-h) + 60px);
    }
    
    .sticky-unit {
        /* Optional: Kleiner zusätzlicher Abstand zum Logo-Header */
        margin-top: 10px;
    }
}

/* Chrome, Safari, Edge, Opera */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Firefox */
input[type=number] {
    -moz-appearance: textfield;
}

/* --- 3. MOBILE OPTIMIERUNG (Erinnerung) --- */
@media (max-width: 768px) {
    .page-base {
        /* Mobil lassen wir es kompakt, wie du sagtest, dass es passt */
        padding-top: calc(var(--header-h) + var(--filter-h) + 25px);
    }
}
</style>

<script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(import.meta.env.PUBLIC_SUPABASE_URL, import.meta.env.PUBLIC_SUPABASE_ANON_KEY);

    const toggle = document.getElementById('filter-toggle');
    const drawer = document.getElementById('filter-drawer');
    const grid = document.getElementById('results-grid');
    const reset = document.getElementById('reset-btn');
    let activeCat = "";

    toggle.addEventListener('click', () => {
        drawer.classList.toggle('open');
        toggle.classList.toggle('active');
    });

    reset.addEventListener('click', () => {
        document.getElementById('main-search').value = "";
        document.getElementById('city-input').value = "";
        document.getElementById('max-price').value = "";
        document.getElementById('max-dist').value = "";
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        document.querySelector('.pill[data-cat=""]').classList.add('active');
        activeCat = "";
        fetch();
    });

    async function fetch() {
        let query = supabase.from('listings').select('*');
        const search = document.getElementById('main-search').value;
        const city = document.getElementById('city-input').value;
        const price = document.getElementById('max-price').value;

        if (search) query = query.ilike('event_name', `%${search}%`);
        if (city) query = query.ilike('location', `%${city}%`);
        if (activeCat) query = query.eq('category', activeCat);
        if (price) query = query.lte('price', price);

        const { data } = await query.order('event_date', { ascending: true });
        grid.innerHTML = data.map(e => `
            <a href="/listing/${e.id}?from=search" class="card-link">
                <div class="e-card">
                    <div class="c-top"><span class="c-tag">${e.category}</span><span style="color:#444; font-size:11px">${new Date(e.event_date).toLocaleDateString()}</span></div>
                    <h3>${e.event_name}</h3>
                    <p style="color:#666; font-size:0.85rem">${e.location}</p>
                    <div class="c-bottom"><span class="val">${e.price}€</span><div style="background:var(--cyan);color:black;padding:4px 8px;border-radius:6px;font-weight:900;font-size:10px">DEAL</div></div>
                </div>
            </a>
        `).join('');
        document.getElementById('res-count').innerText = `${data.length} Events gefunden`;
    }

    document.querySelectorAll('.pill').forEach(p => p.addEventListener('click', (e) => {
        document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        activeCat = e.target.dataset.cat;
        fetch();
    }));

    document.getElementById('apply-btn').addEventListener('click', () => { drawer.classList.remove('open'); toggle.classList.remove('active'); fetch(); });
    document.getElementById('main-search').addEventListener('input', fetch);
    fetch();
</script>