---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Startpl√§tze f√ºr Marathon, Triathlon, Radsport und Hyrox finden">
    <main class="page-base">
        
        <div class="sticky-unit">
            <div class="unit-inner">
                <div class="action-bar">
                    <div class="search-wrap">
                        <svg class="icon-s" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path>
                        </svg>
                        <input type="text" id="main-search" placeholder="Event suchen..." autocomplete="off" />
                    </div>
                    
                    <button id="filter-toggle" class="t-btn">
    <svg 
        width="24" 
        height="24" 
        viewBox="0 0 24 24" 
        fill="none" 
        stroke="currentColor" 
        stroke-width="2.5" 
        stroke-linecap="round" 
        stroke-linejoin="round"
        style="display: block; width: 24px; height: 24px;"
    >
        <line x1="4" y1="21" x2="4" y2="14"></line>
        <line x1="4" y1="10" x2="4" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12" y2="3"></line>
        <line x1="20" y1="21" x2="20" y2="16"></line>
        <line x1="20" y1="12" x2="20" y2="3"></line>
        <line x1="1" y1="14" x2="7" y2="14"></line>
        <line x1="9" y1="8" x2="15" y2="8"></line>
        <line x1="17" y1="16" x2="23" y2="16"></line>
    </svg>
</button>
                </div>

                <div id="filter-drawer" class="drawer">
                    <div class="drawer-content">
                        
                        <div class="f-section">
                            <label>Sportart</label>
                            <div class="p-scroll">
                                <button class="pill active" data-cat="">Alle</button>
                                <button class="pill" data-cat="Radrennen">Radrennen</button>
                                <button class="pill" data-cat="Laufen">Laufen</button>
                                <button class="pill" data-cat="Triathlon">Triathlon</button>
                                <button class="pill" data-cat="Hyrox">Hyrox</button>
                            </div>
                        </div>

                        <div class="f-section">
                            <label>Standort & Umkreis</label>
                            <div class="loc-row">
                                <input type="text" id="city-input" placeholder="Stadt..." />
                                <select id="range-select">
                                    <option value="0">Ort</option>
                                    <option value="50">+50km</option>
                                    <option value="100">+100km</option>
                                </select>
                            </div>
                        </div>

                        <div class="f-section grid-2">
    <div>
        <label>Preis bis (‚Ç¨)</label>
        <input type="number" id="max-price" placeholder="Max" />
    </div>
    <div>
        <label>Distanz (z.B. 42 oder Halbmarathon)</label>
        <input type="text" id="max-dist" placeholder="Suchen..." />
    </div>
</div>

                        <div class="f-actions">
                            <button id="reset-btn" class="r-btn">Zur√ºcksetzen</button>
                            <button id="apply-btn" class="a-btn">Anwenden</button>
                        </div>
                    </div>
                </div>

                <div class="status-line">
                    <span id="res-count">Events werden geladen...</span>
                </div>
            </div>
        </div>

        <section class="feed">
            <div id="results-grid" class="grid-layout">
                </div>
        </section>

    </main>
    <Footer />
</Layout>

<style is:global>
    :root {
        --cyan: #00bcd4;
        --header-h: 80px;
        --filter-h: 80px;
        --bg: var(--bg-body);
    }

    /* Damit der Content nicht unter den fixierten Filtern verschwindet */
    .page-base {
        background: var(--bg-body);
        min-height: 100dvh;
        padding-top: calc(var(--header-h) + var(--filter-h) + 30px);
    }

    /* FIXIERTER BLOCK UNTER LOGO */
    .sticky-unit {
        position: absolute;
        top: var(--header-h);
        left: 0;
        right: 0;
        z-index: 990;
        background: var(--bg-body);
        border-radius: 15px;
        backdrop-filter: none;
        border-bottom: 5px solid rgba(255,255,255,0.05);
        padding: 12px 0;
    }

    .unit-inner {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .action-bar {
        display: flex;
        gap: 10px;
    }

    .search-wrap {
        flex: 1;
        background: #121212;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 14px;
        display: flex;
        align-items: center;
        padding: 0 12px;
    }

    .icon-s { width: 18px; color: var(--cyan); }
    #main-search {
        background: transparent; border: none; color: white;
        padding: 12px 8px; font-size: 16px; width: 100%; outline: none;
    }

    .t-btn {
        background: #121212; border: 1px solid rgba(255,255,255,0.1);
        color: white; border-radius: 14px; width: 48px; height: 48px;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .t-btn.active { background: var(--cyan); color: black; }

    /* DRAWER */
    .drawer {
        max-height: 0; overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
    }
    .drawer.open {
        max-height: 500px; opacity: 1; padding-top: 20px;
    }

    .f-section { margin-bottom: 18px; }
    .f-section label {
        display: block; color: #444; font-size: 10px;
        text-transform: uppercase; font-weight: 900; margin-bottom: 8px;
    }

    .p-scroll { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
    .pill {
        background: #1a1a1a; border: 1px solid rgba(255,255,255,0.05); color: #666;
        padding: 8px 16px; border-radius: 100px; font-size: 12px; font-weight: 700; white-space: nowrap; cursor: pointer;
    }
    .pill.active { background: var(--cyan); color: black; }

    .loc-row, .grid-2 { display: flex; gap: 8px; }
    .grid-2 > div { flex: 1; }

    input[type="text"], input[type="number"], select {
        background: #1a1a1a; border: 1px solid rgba(255,255,255,0.08);
        color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; font-size: 16px;
    }

    .f-actions {
        display: flex; justify-content: space-between; align-items: center;
        padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .a-btn { background: var(--cyan); color: black; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; }
    .r-btn { background: transparent; border: none; color: #ff5252; font-size: 13px; font-weight: 700; cursor: pointer; }

    .status-line { text-align: center; margin-top: 10px; }
    #res-count { font-size: 9px; color: rgba(0, 188, 212, 0.6); text-transform: uppercase; font-weight: 900; letter-spacing: 1px; }

    /* RESULTS GRID */
    .feed { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 0 15px 100px; }
    .grid-layout {
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 16px;
        width: 100%; 
        max-width: 900px;
    }
    @media (min-width: 768px) { 
        .grid-layout { 
            grid-template-columns: 1fr 1fr; 
        } 
    }

    /* KOMPAKTE CARDS F√úR SUCHSEITE */
    .e-card {
        background: #111;
        padding: 18px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.08);
        color: white;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .e-card:hover {
        transform: translateY(-3px);
        border-color: var(--cyan);
        box-shadow: 0 8px 20px rgba(0, 188, 212, 0.15);
    }

    /* Top Row: Event Name + Sport Badge */
    .c-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
    }

    .event-name {
        color: white;
        font-size: 1.05rem;
        font-weight: 900;
        line-height: 1.2;
        flex: 1;
    }

    .sport-badge {
        background: rgba(0, 188, 212, 0.1);
        color: var(--cyan);
        font-size: 0.65rem;
        font-weight: 900;
        text-transform: uppercase;
        padding: 4px 10px;
        border-radius: 6px;
        white-space: nowrap;
        letter-spacing: 0.5px;
        flex-shrink: 0;
    }

    /* Middle: Meta Info */
    .c-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 0;
        border-top: 1px solid rgba(255,255,255,0.05);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .meta-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
    }
    
    .meta-row.split {
        display: flex;
        justify-content: space-between;
        gap: 12px;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .meta-label {
        color: #666;
        font-weight: 700;
        font-size: 0.65rem;
        text-transform: uppercase;
    }

    .meta-value {
        color: #ccc;
        font-weight: 500;
    }

    /* Bottom: Price + Details Button */
    .c-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .price-val {
        color: var(--cyan);
        font-size: 1.8rem;
        font-weight: 900;
        line-height: 1;
    }

    .details-link {
        background: var(--cyan);
        color: #000;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .details-link:hover {
        background: white;
        transform: translateX(2px);
    }

    /* Desktop Spacing */
    @media (min-width: 1024px) {
        .page-base {
            padding-top: calc(var(--header-h) + var(--filter-h) + 60px);
        }
        
        .sticky-unit {
            margin-top: 10px;
        }
    }

    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }

    /* Mobile Optimization */
    @media (max-width: 768px) {
        .page-base {
            padding-top: calc(var(--header-h) + var(--filter-h) + 25px);
        }
        
        .event-name {
            font-size: 0.95rem;
        }
        
        .price-val {
            font-size: 1.5rem;
        }
        
        .details-link {
            padding: 8px 16px;
            font-size: 0.7rem;
        }
    }
</style>

<script>
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(import.meta.env.PUBLIC_SUPABASE_URL, import.meta.env.PUBLIC_SUPABASE_ANON_KEY);

    const toggle = document.getElementById('filter-toggle') as HTMLElement;
    const drawer = document.getElementById('filter-drawer') as HTMLElement;
    const grid = document.getElementById('results-grid') as HTMLElement;
    const reset = document.getElementById('reset-btn') as HTMLElement;
    const applyBtn = document.getElementById('apply-btn') as HTMLElement;
    
    let activeCat = "";

    if (toggle && drawer) {
        toggle.addEventListener('click', () => {
            drawer.classList.toggle('open');
            toggle.classList.toggle('active');
        });
    }

   async function performFetch() {
        if (!grid) return;
        
        const countDisplay = document.getElementById('res-count');
        if (countDisplay) countDisplay.innerText = "Suche l√§uft...";

        const searchVal = (document.getElementById('main-search') as HTMLInputElement).value;
        const cityVal = (document.getElementById('city-input') as HTMLInputElement).value;
        const priceVal = (document.getElementById('max-price') as HTMLInputElement).value;
        const distVal = (document.getElementById('max-dist') as HTMLInputElement).value; // Das ist die Renn-Distanz (z.B. 10km Lauf)
        
        // NEU: Wir brauchen ein Feld f√ºr den geografischen Umkreis (z.B. radiusVal)
        // Falls du kein extra Feld hast, nehmen wir hier mal fix 50 (km) als Beispiel oder du f√ºgst ein Feld 'radius-input' hinzu
        const radiusVal = 50; 

        let data = [];
        let error = null;

        // --- FALL A: Umkreissuche (Wenn ein Ort eingegeben wurde) ---
        if (cityVal) {
            // 1. Koordinaten der Stadt via OpenStreetMap (Nominatim) holen
            try {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityVal)}&limit=1`);
                const geoData = await geoRes.json();

                if (geoData.length > 0) {
                    const { lat, lon } = geoData[0];

                    // 2. Deine neue Supabase-Funktion aufrufen
                    const { data: rpcData, error: rpcError } = await supabase.rpc('get_listings_in_radius', {
                        target_lat: parseFloat(lat),
                        target_lng: parseFloat(lon),
                        radius_km: parseFloat(radiusVal.toString())
                    });
                    
                    data = rpcData;
                    error = rpcError;
                }
            } catch (err) {
                console.error("Geocoding Fehler:", err);
            }
        } 
        
        // --- FALL B: Normale Suche (Wenn kein Ort oder Geocoding fehlgeschlagen) ---
        if (!cityVal || data.length === 0) {
            let query = supabase.from('listings').select('*').eq('approved', true).eq('status', 'active');
            if (searchVal) query = query.ilike('event_name', `%${searchVal}%`);
            if (cityVal) query = query.ilike('location', `%${cityVal}%`); // Fallback auf Textsuche
            
            const { data: normalData, error: normalError } = await query;
            data = normalData;
            error = normalError;
        }

        // --- MANUELLES FILTERN (F√ºr die restlichen Felder nach der RPC-Abfrage) ---
        if (data) {
            let filtered = data;

            // Kategorie Filter
            if (activeCat) {
                filtered = filtered.filter(e => e.category === activeCat);
            }
            // Preis Filter
            if (priceVal) {
                filtered = filtered.filter(e => e.price <= parseFloat(priceVal));
            }
            // Renn-Distanz Filter (distance_km)
            if (distVal && activeCat !== 'Hyrox') {
                filtered = filtered.filter(e => e.distance_km <= parseFloat(distVal));
            }
            // Textsuche Filter (falls RPC genutzt wurde)
            if (searchVal && cityVal) {
                filtered = filtered.filter(e => e.event_name.toLowerCase().includes(searchVal.toLowerCase()));
            }

            renderGrid(filtered); // Wir lagern das Rendern aus
        }
    }

    // Hilfsfunktion zum Anzeigen der Karten
    function renderGrid(data) {
        const grid = document.getElementById('results-grid');
        const countDisplay = document.getElementById('res-count');
        
        if (!grid) return;

        grid.innerHTML = data.map(e => {
            let distanceAnzeige = `<span class="meta-value">${e.distance || 'N/A'}</span>`;
            if (e.category === 'Triathlon' && e.swim_dist !== null) {
                distanceAnzeige = `<span class="meta-value" style="font-size: 0.85em;">üèä ${e.swim_dist}km | üö¥ ${e.bike_dist}km | üèÉ ${e.run_dist}km</span>`;
            }

            return `
            <div class="e-card">
                <div class="c-top">
                    <div class="event-name">${e.event_name}</div>
                    <div class="sport-badge">${e.category}</div>
                </div>
                <div class="c-meta">
                    <div class="meta-row split">
                        <div class="meta-item">
                            <span class="meta-label">Ort:</span>
                            <span class="meta-value">${e.location}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Datum:</span>
                            <span class="meta-value">${new Date(e.event_date).toLocaleDateString('de-DE')}</span>
                        </div>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Distanz:</span>
                        ${distanceAnzeige}
                    </div>
                </div>
                <div class="c-bottom">
                    <div class="price-val">${e.price}‚Ç¨</div>
                    <a href="/listing/${e.id}?from=search" class="details-link">Details ‚Üí</a>
                </div>
            </div>
        `}).join('');

        if (countDisplay) {
            countDisplay.innerText = data.length === 0 ? "Aktuell keine passenden Startpl√§tze gefunden" : `${data.length} aktive Events gefunden`;
        }
    }

    // Event Listener f√ºr die Pillen (Kategorien)
    document.querySelectorAll('.pill').forEach(p => p.addEventListener('click', (e) => {
        const currentPill = e.currentTarget as HTMLElement;
        document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
        currentPill.classList.add('active');
        activeCat = currentPill.dataset.cat || "";

        // UI-INTELLIGENZ: Eingabefeld anpassen
        const distInput = document.getElementById('max-dist') as HTMLInputElement;
        if (distInput) {
            if (activeCat === 'Hyrox') {
                distInput.disabled = true;
                distInput.value = "";
                distInput.placeholder = "Nicht relevant f√ºr Hyrox";
                distInput.style.opacity = "0.5";
            } else if (activeCat === 'Triathlon') {
                distInput.disabled = false;
                distInput.placeholder = "Max. Rad-Strecke (km)";
                distInput.style.opacity = "1";
            } else {
                distInput.disabled = false;
                distInput.placeholder = "Max. Distanz (km)";
                distInput.style.opacity = "1";
            }
        }

        performFetch();
    }));

    // Reset Funktion
    reset?.addEventListener('click', () => {
        (document.getElementById('main-search') as HTMLInputElement).value = "";
        (document.getElementById('city-input') as HTMLInputElement).value = "";
        (document.getElementById('max-price') as HTMLInputElement).value = "";
        
        const distInput = document.getElementById('max-dist') as HTMLInputElement;
        if (distInput) {
            distInput.value = "";
            distInput.disabled = false;
            distInput.placeholder = "Max. Distanz (km)";
            distInput.style.opacity = "1";
        }

        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        document.querySelector('.pill[data-cat=""]')?.classList.add('active');
        activeCat = "";
        performFetch();
    });

    applyBtn?.addEventListener('click', () => {
        drawer?.classList.remove('open');
        toggle?.classList.remove('active');
        performFetch();
    });

    // Sofortige Suche beim Tippen im Hauptfeld
    document.getElementById('main-search')?.addEventListener('input', () => {
        performFetch();
    });

    // Initialer Aufruf
    performFetch();
</script>