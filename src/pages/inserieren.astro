---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
import Popup from '../components/Popup.astro';
---

<Layout title="Startplatz inserieren - Startplatzbörse">
    <main class="page-wrapper">
        <div class="form-wrapper">
            <div class="container">
                
                <div class="progress-bar">
                    <div class="step active" id="step-dot-1">1</div>
                    <div class="line" id="progress-line"></div>
                    <div class="step" id="step-dot-2">2</div>
                </div>

                <div id="auth-section">
                    <div class="heading">Wer bist du?</div>
                    <p class="info-text">Wir brauchen kurz deine Daten für die Verifizierung.</p>
                    
                    <div id="step-1">
                        <div class="row">
                            <div class="col">
                                <label class="input-label">Vorname</label>
                                <input class="input" type="text" id="vorname" placeholder="Max">
                            </div>
                            <div class="col">
                                <label class="input-label">Nachname</label>
                                <input class="input" type="text" id="nachname" placeholder="Mustermann">
                            </div>
                        </div>

                        <label class="input-label">Dein Nickname (öffentlich sichtbar)</label>
                        <div class="input-wrapper">
                            <span class="prefix">@</span>
                            <input class="input with-prefix" type="text" id="nickname" placeholder="IronMan99">
                        </div>

                        <label class="input-label">E-Mail Adresse</label>
                        <input class="input" type="email" id="email" placeholder="deine@mail.de">
                        
                        <button class="login-button" id="btn-send-otp">Code anfordern</button>
                    </div>

                    <div id="step-otp" style="display: none;">
                        <p class="info-text">Check dein Postfach! Gib den 6-stelligen Code hier ein:</p>
                        <input class="input" type="text" id="otp-code" placeholder="123456" maxlength="6" style="text-align: center; letter-spacing: 5px; font-size: 1.2rem;">
                        <button class="login-button" id="btn-verify-otp">Identität bestätigen</button>
                    </div>
                </div>

                <div id="listing-section" style="display: none;">
                    <div class="heading">Event Details</div>
                    <p class="info-text">Fast geschafft! Gib jetzt die Daten zu deinem Startplatz an.</p>
                    
                    <form id="listing-form">
                        <label class="input-label">Sportart</label>
                        <select required class="input select-input" id="category" name="category">
                            <option value="" disabled selected>Bitte wählen...</option>
                            <option value="Laufen">Laufen</option>
                            <option value="Radrennen">Radrennen</option>
                            <option value="Triathlon">Triathlon</option>
                            <option value="Hyrox">Hyrox</option>
                        </select>

                        <label class="input-label">Name des Events</label>
                        <input required class="input" type="text" name="event_name" placeholder="z.B. Berlin Marathon">
                        
                        <div class="row">
                            <div class="col">
                                <label class="input-label">Distanz</label>
                                <select required class="input select-input" id="distance-select" name="distance">
                                    <option value="">Erst Sportart wählen</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="input-label">Datum</label>
                                <input required class="input" type="date" id="event_date" name="event_date">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label class="input-label">PLZ</label>
                                <input required class="input" type="text" id="plz" name="plz" placeholder="12345" maxlength="5" inputmode="numeric">
                            </div>
                            <div class="col">
                                <label class="input-label">Ort</label>
                                <input required class="input" type="text" id="location" name="location" placeholder="Ort eingeben">
                            </div>
                        </div>

                        <label class="input-label">Dein Preis (in €)</label>
                        <div class="price-input-wrapper">
                            <input required class="input" type="number" name="price" id="price" placeholder="50" min="1">
                            <span class="currency-suffix">€</span>
                        </div>

                        <div class="checkbox-wrapper">
                            <input type="checkbox" required id="confirm-transfer">
                            <label for="confirm-transfer">Ich bestätige, dass eine offizielle Ummeldung möglich ist.</label>
                        </div>

                        <button class="login-button" type="submit" id="btn-final">Inserat jetzt veröffentlichen</button>
                    </form>
                </div>

            </div>
        </div>

        <Popup id="status-popup" title="Systemmeldung">
            <p id="popup-text" style="color: #ccc; margin-bottom: 20px;"></p>
            <button class="login-button" onclick="document.getElementById('status-popup').style.display='none'">Alles klar</button>
        </Popup>
    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    // --- DOM ELEMENTE ---
    const authSection = document.getElementById('auth-section');
    const step1 = document.getElementById('step-1');
    const stepOtp = document.getElementById('step-otp');
    const listingSection = document.getElementById('listing-section');
    
    // Inputs Auth
    const inputVorname = document.getElementById('vorname') as HTMLInputElement;
    const inputNachname = document.getElementById('nachname') as HTMLInputElement;
    const inputNickname = document.getElementById('nickname') as HTMLInputElement;
    const inputEmail = document.getElementById('email') as HTMLInputElement;
    const inputOtp = document.getElementById('otp-code') as HTMLInputElement;

    // Inputs Listing
    const categorySelect = document.getElementById('category') as HTMLSelectElement;
    const distanceSelect = document.getElementById('distance-select') as HTMLSelectElement;
    const plzInput = document.getElementById('plz') as HTMLInputElement;
    const locationInput = document.getElementById('location') as HTMLInputElement;
    const dateInput = document.getElementById('event_date') as HTMLInputElement;

    // UI Elemente
    const stepDot2 = document.getElementById('step-dot-2');
    const progressLine = document.getElementById('progress-line');

    // --- HILFSFUNKTIONEN ---
    function showPopup(title: string, message: string) {
        const popup = document.getElementById('status-popup');
        const popupTitle = popup?.querySelector('h3');
        const popupText = document.getElementById('popup-text');
        if (popup && popupTitle && popupText) {
            popupTitle.innerText = title;
            popupText.innerText = message;
            popup.style.display = 'flex';
        }
    }

    // 1. Validierung & OTP Senden
    document.getElementById('btn-send-otp')?.addEventListener('click', async () => {
        const email = inputEmail.value.trim();
        const nickname = inputNickname.value.trim();
        const vorname = inputVorname.value.trim();
        const nachname = inputNachname.value.trim();

        if(!email.includes('@')) return showPopup("Fehler", "Bitte gültige E-Mail angeben.");
        if(nickname.length < 3) return showPopup("Fehler", "Nickname muss mind. 3 Zeichen haben.");
        if(!vorname || !nachname) return showPopup("Fehler", "Bitte Vor- und Nachname ausfüllen.");

        const btn = document.getElementById('btn-send-otp') as HTMLButtonElement;
        btn.textContent = "Sende Code...";
        btn.disabled = true;

        const { error } = await supabase.auth.signInWithOtp({ email });

        if (error) {
            showPopup("Fehler", error.message);
            btn.textContent = "Code anfordern";
            btn.disabled = false;
        } else {
            step1!.style.display = 'none';
            stepOtp!.style.display = 'block';
        }
    });

    // 2. OTP Verifizieren & PROFIL SPEICHERN (Wichtig!)
    document.getElementById('btn-verify-otp')?.addEventListener('click', async () => {
        const email = inputEmail.value.trim();
        const token = inputOtp.value.trim();
        const nickname = inputNickname.value.trim();
        const vorname = inputVorname.value.trim();
        const nachname = inputNachname.value.trim();

        const btn = document.getElementById('btn-verify-otp') as HTMLButtonElement;
        btn.textContent = "Prüfe...";
        btn.disabled = true;

        // A. Login prüfen
        const { data, error } = await supabase.auth.verifyOtp({ email, token, type: 'email' });
        
        if (error || !data.user) {
            // Fallback für Signup Link Typen (manchmal nötig)
            const { data: data2, error: err2 } = await supabase.auth.verifyOtp({ email, token, type: 'signup' });
            if (err2 || !data2.user) {
                btn.textContent = "Identität bestätigen";
                btn.disabled = false;
                return showPopup("Ungültig", "Falscher Code.");
            }
        }

        const user = data.user || (await supabase.auth.getUser()).data.user;

        if (user) {
            // B. PROFIL UPDATE (Hier passiert die Magie)
            
            // 1. Nickname in die 'profiles' Tabelle schreiben (die wir vorhin erstellt haben)
            const { error: profileError } = await supabase
                .from('profiles')
                .upsert({
                    id: user.id,
                    nickname: nickname,
                    // avatar_url: ... (optional später)
                });

            // 2. Echte Namen in die Auth-Metadaten schreiben (Standard Supabase)
            await supabase.auth.updateUser({
                data: { first_name: vorname, last_name: nachname }
            });

            if (profileError) {
                console.error("Profil Fehler:", profileError);
                // Wir lassen den User trotzdem weiter, aber loggen den Fehler
            }

            // C. Weiter zum Listing
            authSection!.style.display = 'none';
            listingSection!.style.display = 'block';
            stepDot2!.classList.add('active');
            progressLine!.style.background = '#00bcd4';
        }
    });

    // 3. Listings Logik (Distanzen, PLZ, Submit)
    const today = new Date().toISOString().split('T')[0];
    if (dateInput) dateInput.min = today;

    const distances = {
        Laufen: ['5 km', '10 km', 'Halbmarathon', 'Marathon', 'Ultra'],
        Radrennen: ['Jedermann (kurz)', 'Jedermann (lang)', 'RTF', 'Kriterium', 'Radmarathon'],
        Triathlon: ['Sprint', 'Olympisch', 'Mitteldistanz', 'Langdistanz'],
        Hyrox: ['Open Men/Women', 'Pro Men/Women', 'Doubles', 'Relay']
    };

    categorySelect?.addEventListener('change', () => {
        const selected = categorySelect.value as keyof typeof distances;
        distanceSelect.innerHTML = '';
        distances[selected].forEach(dist => {
            const opt = document.createElement('option');
            opt.value = dist;
            opt.textContent = dist;
            distanceSelect.appendChild(opt);
        });
    });

    plzInput?.addEventListener('input', async (e) => {
        const target = e.target as HTMLInputElement;
        target.value = target.value.replace(/\D/g, ''); 
        if (target.value.length === 5) {
            locationInput.placeholder = "Suche Stadt...";
            try {
                const response = await fetch(`https://api.zippopotam.us/de/${target.value}`);
                if (response.ok) {
                    const data = await response.json();
                    locationInput.value = data.places[0]['place name'];
                }
            } catch (err) { console.error("PLZ API Error"); }
        }
    });

    // 4. Listing Absenden
    document.getElementById('listing-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-final') as HTMLButtonElement;
        btn.disabled = true;
        btn.textContent = "Sende...";

        try {
            const { data: authData } = await supabase.auth.getUser();
            if (!authData.user) throw new Error("Sitzung abgelaufen.");

            const formData = new FormData(e.target as HTMLFormElement);
            const vals = Object.fromEntries(formData);
            
            // Wir speichern hier die Namen nochmal redundat ins Listing, falls gewünscht.
            // Aber eigentlich haben wir sie jetzt im Profil (sauberer).
            const { error: insertError } = await supabase.from('listings').insert([{
                user_id: authData.user.id,
                vorname: inputVorname.value,
                nachname: inputNachname.value,
                seller_email: inputEmail.value,
                category: vals.category,
                event_name: vals.event_name,
                distance: vals.distance,
                event_date: vals.event_date,
                plz: vals.plz,
                location: vals.location,
                price: parseFloat(vals.price as string),
                approved: true
            }]);

            if (insertError) throw insertError;

            showPopup("Glückwunsch!", "Dein Inserat ist online!");
            setTimeout(() => { window.location.href = "/dashboard"; }, 2000);

        } catch (err: any) {
            showPopup("Fehler", err.message);
            btn.disabled = false;
            btn.textContent = "Inserat jetzt veröffentlichen";
        }
    });
</script>

<style>
    /* Styling Updates für Nickname Feld */
    .input-wrapper {
        position: relative;
        width: 100%;
    }
    .prefix {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--cyan);
        font-weight: bold;
        z-index: 2;
    }
    .input.with-prefix {
        padding-left: 30px; /* Platz für das @ Zeichen */
    }

    /* Restliches CSS (unverändert) */
    :root { --cyan: #00bcd4; --bg: #121212; --card: #222; }
    .page-wrapper { min-height: 100vh; background: var(--bg); padding: 80px 20px; font-family: 'Inter', sans-serif; color: white; }
    .form-wrapper { display: flex; justify-content: center; }
    .container { 
        max-width: 550px; width: 100%; background: var(--card); border-radius: 24px; 
        padding: 40px; border: 1px solid rgba(255,255,255,0.1); 
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .progress-bar { display: flex; align-items: center; justify-content: center; margin-bottom: 40px; }
    .step { width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; transition: 0.3s; }
    .step.active { background: var(--cyan); color: black; box-shadow: 0 0 15px var(--cyan); }
    .line { width: 60px; height: 2px; background: #333; margin: 0 10px; }
    .heading { font-size: 1.8rem; font-weight: 800; text-align: center; color: var(--cyan); margin-bottom: 8px; }
    .info-text { text-align: center; color: #aaa; font-size: 0.9rem; margin-bottom: 30px; }
    .input-label { display: block; font-size: 0.8rem; font-weight: 600; margin: 15px 0 6px 4px; color: #eee; }
    .input { 
        width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 14px; 
        border-radius: 12px; color: white; outline: none; transition: 0.3s; box-sizing: border-box;
    }
    .input:focus { border-color: var(--cyan); background: #222; }
    .row { display: flex; gap: 15px; margin-bottom: 10px; }
    .col { flex: 1; }
    .price-input-wrapper { position: relative; }
    .currency-suffix { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--cyan); font-weight: bold; }
    .checkbox-wrapper { display: flex; gap: 10px; margin-top: 20px; font-size: 0.8rem; color: #999; align-items: center; }
    .login-button { 
        width: 100%; background: var(--cyan); color: black; padding: 16px; border-radius: 12px; 
        border: none; font-weight: 800; cursor: pointer; margin-top: 25px; transition: 0.3s;
    }
    .login-button:hover { transform: translateY(-2px); opacity: 0.9; }
    .login-button:disabled { background: #444; cursor: not-allowed; }
    @media (max-width: 500px) { .row { flex-direction: column; gap: 0; } }
</style>