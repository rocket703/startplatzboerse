---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Startplatz inserieren - Startplatzbörse">
    <main class="page-wrapper">
        <div class="form-wrapper">
            <div class="container">
                
                <div class="progress-bar">
                    <div class="step active" id="step-dot-1">1</div>
                    <div class="line" id="progress-line"></div>
                    <div class="step" id="step-dot-2">2</div>
                </div>

                <div id="auth-section">
                    <div class="heading">Wer bist du?</div>
                    <p class="info-text">Verifiziere kurz deine E-Mail, damit wir wissen, dass du kein Roboter bist.</p>
                    
                    <div id="step-1">
                        <div class="row">
                            <div class="col">
                                <label class="input-label">Vorname</label>
                                <input class="input" type="text" id="vorname" placeholder="Max">
                            </div>
                            <div class="col">
                                <label class="input-label">Nachname</label>
                                <input class="input" type="text" id="nachname" placeholder="Mustermann">
                            </div>
                        </div>
                        <label class="input-label">E-Mail Adresse</label>
                        <input class="input" type="email" id="email" placeholder="deine@mail.de">
                        
                        <button class="login-button" id="btn-send-otp">Code anfordern</button>
                    </div>

                    <div id="step-otp" style="display: none;">
                        <p class="info-text">Check dein Postfach! Gib den 6-stelligen Code hier ein:</p>
                        <input class="input" type="text" id="otp-code" placeholder="123456" maxlength="6">
                        <button class="login-button" id="btn-verify-otp">Identität bestätigen</button>
                    </div>
                </div>

                <div id="listing-section" style="display: none;">
                    <div class="heading">Event Details</div>
                    <p class="info-text">Fast geschafft! Gib jetzt die Daten zu deinem Startplatz an.</p>
                    
                    <form id="listing-form">
                        <label class="input-label">Sportart</label>
                        <select required class="input select-input" id="category" name="category">
                            <option value="" disabled selected>Bitte wählen...</option>
                            <option value="Laufen">Laufen</option>
                            <option value="Radrennen">Radrennen</option>
                            <option value="Triathlon">Triathlon</option>
                            <option value="Hyrox">Hyrox</option>
                        </select>

                        <label class="input-label">Name des Events</label>
                        <input required class="input" type="text" name="event_name" placeholder="z.B. Berlin Marathon">
                        
                        <div class="row">
                            <div class="col">
                                <label class="input-label">Distanz</label>
                                <select required class="input select-input" id="distance-select" name="distance">
                                    <option value="">Erst Sportart wählen</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="input-label">Datum</label>
                                <input required class="input" type="date" id="event_date" name="event_date">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label class="input-label">PLZ</label>
                                <input required class="input" type="text" id="plz" name="plz" placeholder="12345" maxlength="5" inputmode="numeric">
                            </div>
                            <div class="col">
                                <label class="input-label">Ort</label>
                                <input required class="input" type="text" id="location" name="location" placeholder="Ort eingeben">
                            </div>
                        </div>

                        <label class="input-label">Dein Preis (in €)</label>
                        <div class="price-input-wrapper">
                            <input required class="input" type="number" name="price" id="price" placeholder="50" min="1">
                            <span class="currency-suffix">€</span>
                        </div>

                        <div class="checkbox-wrapper">
                            <input type="checkbox" required id="confirm-transfer">
                            <label for="confirm-transfer">Ich bestätige, dass eine offizielle Ummeldung möglich ist.</label>
                        </div>

                        <button class="login-button" type="submit" id="btn-final">Inserat jetzt veröffentlichen</button>
                    </form>
                </div>

            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    // DOM Elemente
    const authSection = document.getElementById('auth-section');
    const step1 = document.getElementById('step-1');
    const stepOtp = document.getElementById('step-otp');
    const listingSection = document.getElementById('listing-section');
    const categorySelect = document.getElementById('category') as HTMLSelectElement;
    const distanceSelect = document.getElementById('distance-select') as HTMLSelectElement;
    const stepDot2 = document.getElementById('step-dot-2');
    const progressLine = document.getElementById('progress-line');
    
    const plzInput = document.getElementById('plz') as HTMLInputElement;
    const locationInput = document.getElementById('location') as HTMLInputElement;
    const dateInput = document.getElementById('event_date') as HTMLInputElement;

    // 1. DATUM-SPERRE (Heute als Minimum)
    const today = new Date().toISOString().split('T')[0];
    if (dateInput) dateInput.min = today;

    // 2. DISTANZEN-LOGIK
    const distances = {
        Laufen: ['5 km', '10 km', 'Halbmarathon', 'Marathon', 'Ultra'],
        Radrennen: ['Jedermann (kurz)', 'Jedermann (lang)', 'RTF', 'Kriterium', 'Radmarathon'],
        Triathlon: ['Sprint', 'Olympisch', 'Mitteldistanz', 'Langdistanz'],
        Hyrox: ['Open Men/Women', 'Pro Men/Women', 'Doubles', 'Relay']
    };

    categorySelect?.addEventListener('change', () => {
        const selected = categorySelect.value as keyof typeof distances;
        distanceSelect.innerHTML = '';
        distances[selected].forEach(dist => {
            const opt = document.createElement('option');
            opt.value = dist;
            opt.textContent = dist;
            distanceSelect.appendChild(opt);
        });
    });

    // 3. PLZ AUTOFILL & VALIDIERUNG
    plzInput?.addEventListener('input', async (e) => {
        const target = e.target as HTMLInputElement;
        target.value = target.value.replace(/\D/g, ''); // Nur Zahlen
        
        if (target.value.length === 5) {
            locationInput.placeholder = "Suche Stadt...";
            try {
                const response = await fetch(`https://api.zippopotam.us/de/${target.value}`);
                if (response.ok) {
                    const data = await response.json();
                    locationInput.value = data.places[0]['place name'];
                }
            } catch (err) { console.error("PLZ API Error"); }
        }
    });

    // 4. AUTH LOGIK (OTP SENDEN)
    document.getElementById('btn-send-otp')?.addEventListener('click', async () => {
        const email = (document.getElementById('email') as HTMLInputElement).value;
        if(!email.includes('@')) return alert("Bitte gültige E-Mail angeben");

        const { error } = await supabase.auth.signInWithOtp({ email });
        if (error) alert(error.message);
        else {
            step1!.style.display = 'none';
            stepOtp!.style.display = 'block';
        }
    });

    // 5. AUTH LOGIK (OTP VERIFIZIEREN)
    document.getElementById('btn-verify-otp')?.addEventListener('click', async () => {
        const email = (document.getElementById('email') as HTMLInputElement).value;
        const token = (document.getElementById('otp-code') as HTMLInputElement).value;

        const { error } = await supabase.auth.verifyOtp({ email, token, type: 'signup' });
        if (error) {
            const { error: err2 } = await supabase.auth.verifyOtp({ email, token, type: 'magiclink' });
            if (err2) return alert("Code ungültig.");
        }
        
        authSection!.style.display = 'none';
        listingSection!.style.display = 'block';
        stepDot2!.classList.add('active');
        progressLine!.style.background = '#00bcd4';
    });

    // 6. FINALES ABSENDEN
    document.getElementById('listing-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-final') as HTMLButtonElement;
    
    // Button sperren gegen Doppel-Klicks
    btn.disabled = true;
    btn.textContent = "Sende...";

    try {
        // 1. WICHTIG: Den User ZUERST abrufen
        const { data: authData, error: userError } = await supabase.auth.getUser();

        if (userError || !authData.user) {
            throw new Error("Du bist nicht eingeloggt oder die Sitzung ist abgelaufen.");
        }

        // Jetzt ist der User bekannt!
        const user = authData.user;

        const formData = new FormData(e.target as HTMLFormElement);
        const vals = Object.fromEntries(formData);
        
        // 2. Inserat mit der user_id abschicken
        const { error: insertError } = await supabase.from('listings').insert([{
            user_id: user.id, // Die neue Verknüpfung für dein Dashboard
            vorname: (document.getElementById('vorname') as HTMLInputElement).value,
            nachname: (document.getElementById('nachname') as HTMLInputElement).value,
            seller_email: (document.getElementById('email') as HTMLInputElement).value,
            category: vals.category,
            event_name: vals.event_name,
            distance: vals.distance,
            event_date: vals.event_date,
            plz: vals.plz,
            location: vals.location,
            price: parseFloat(vals.price as string),
            approved: true
        }]);

        if (insertError) throw insertError;

        // 3. Erfolg! Ab ins Dashboard
        window.location.href = "/dashboard";

    } catch (err: any) {
        // Bei Fehlern: Alarm schlagen und Button wieder freigeben
        console.error("Fehler beim Absenden:", err);
        alert("Achtung: " + err.message);
        
        btn.disabled = false;
        btn.textContent = "Inserat jetzt veröffentlichen";
    }
});
    
</script>

<style>
    :root { --cyan: #00bcd4; --bg: #121212; --card: #222; }
    .page-wrapper { min-height: 100vh; background: var(--bg); padding: 80px 20px; font-family: 'Inter', sans-serif; color: white; }
    .form-wrapper { display: flex; justify-content: center; }
    .container { 
        max-width: 550px; width: 100%; background: var(--card); border-radius: 24px; 
        padding: 40px; border: 1px solid rgba(255,255,255,0.1); 
        box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }
    .progress-bar { display: flex; align-items: center; justify-content: center; margin-bottom: 40px; }
    .step { width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; transition: 0.3s; }
    .step.active { background: var(--cyan); color: black; box-shadow: 0 0 15px var(--cyan); }
    .line { width: 60px; height: 2px; background: #333; margin: 0 10px; }
    .heading { font-size: 1.8rem; font-weight: 800; text-align: center; color: var(--cyan); margin-bottom: 8px; }
    .info-text { text-align: center; color: #aaa; font-size: 0.9rem; margin-bottom: 30px; }
    .input-label { display: block; font-size: 0.8rem; font-weight: 600; margin: 15px 0 6px 4px; color: #eee; }
    .input { 
        width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 14px; 
        border-radius: 12px; color: white; outline: none; transition: 0.3s; box-sizing: border-box;
    }
    .input:focus { border-color: var(--cyan); background: #222; }
    .row { display: flex; gap: 15px; margin-bottom: 10px; }
    .col { flex: 1; }
    .price-input-wrapper { position: relative; }
    .currency-suffix { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--cyan); font-weight: bold; }
    .checkbox-wrapper { display: flex; gap: 10px; margin-top: 20px; font-size: 0.8rem; color: #999; align-items: center; }
    .login-button { 
        width: 100%; background: var(--cyan); color: black; padding: 16px; border-radius: 12px; 
        border: none; font-weight: 800; cursor: pointer; margin-top: 25px; transition: 0.3s;
    }
    .login-button:hover { transform: translateY(-2px); opacity: 0.9; }
    .login-button:disabled { background: #444; cursor: not-allowed; }
    @media (max-width: 500px) { .row { flex-direction: column; gap: 0; } }
</style>