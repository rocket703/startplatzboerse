---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Startplatz inserieren - Startplatzbörse">
    <main class="page-wrapper">
        <div class="form-wrapper">
            <div class="container">
                
                <div class="progress-bar">
                    <div class="step active" id="step-dot-1">1</div>
                    <div class="line" id="progress-line"></div>
                    <div class="step" id="step-dot-2">2</div>
                </div>

                <div id="auth-section">
                    <div class="heading" id="auth-heading">Wer bist du?</div>
                    <p class="info-text" id="auth-info">Wir brauchen kurz deine E-Mail für die Verifizierung.</p>
                    
                    <div id="auth-step-email">
                        <label class="input-label">E-Mail Adresse</label>
                        <input class="input" type="email" id="email" placeholder="deine@mail.de" maxlength="50">
                        <button class="login-button" id="btn-send-otp">Code anfordern</button>
                    </div>

                    <div id="auth-step-otp" style="display: none;">
                        <input class="input" type="text" id="otp-code" placeholder="123456" maxlength="6" style="text-align: center; letter-spacing: 5px;" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <button class="login-button" id="btn-verify-otp">Identität bestätigen</button>
                    </div>

                    <div id="auth-step-profile" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Vorname</label>
                            <input class="input" type="text" id="vorname" placeholder="Dein Vorname" maxlength="30">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Nachname</label>
                            <input class="input" type="text" id="nachname" placeholder="Dein Nachname" maxlength="30">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Dein Nickname</label>
                            <input class="input" type="text" id="nickname" placeholder="3-20 Zeichen" maxlength="20">
                        </div>
                        <button class="login-button" id="btn-save-profile">Profil speichern & weiter</button>
                    </div>
                </div> <div id="listing-section" style="display: none;">
                    <div class="heading">Event Details</div>
                    <p class="info-text">Gib jetzt die Daten zu deinem Startplatz an.</p>
                    
                    <form id="listing-form">
                        <label class="input-label">Sportart</label>
                        <select required class="input select-input" id="category" name="category">
                            <option value="" disabled selected>Bitte wählen...</option>
                            <option value="Laufen">Laufen</option>
                            <option value="Radrennen">Radrennen</option>
                            <option value="Triathlon">Triathlon</option>
                            <option value="Hyrox">Hyrox</option>
                        </select>

                        <label class="input-label">Name des Events</label>
                        <input required class="input" type="text" name="event_name" placeholder="z.B. Berlin Marathon" maxlength="100">
                        
                        <div class="row">
                            <div class="col">
                                <label class="input-label">Distanz</label>
                                <select required class="input select-input" id="distance-select" name="distance">
                                    <option value="">Erst Sportart wählen</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="input-label">Datum</label>
                                <input required class="input" type="date" id="event_date" name="event_date">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <label class="input-label">PLZ</label>
                                <input required class="input" type="text" id="plz" name="plz" placeholder="12345" maxlength="5" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                            </div>
                            <div class="col">
                                <label class="input-label">Ort</label>
                                <input required class="input" type="text" id="location" name="location" placeholder="Ort eingeben" maxlength="50">
                            </div>
                        </div>

                        <label class="input-label">Dein Preis (in €)</label>
                        <div class="price-input-wrapper">
                            <input required class="input" type="number" name="price" id="price" placeholder="50" min="1" max="9999">
                            <span class="currency-suffix">€</span>
                        </div>

                        <div class="checkbox-wrapper">
                            <input type="checkbox" required id="confirm-transfer">
                            <label for="confirm-transfer">Ich bestätige, dass ich die Ummeldung vorab mit der Veranstalter geklärt habe.</label>
                        </div>

                        <button class="login-button" type="submit" id="btn-final">Inserat jetzt veröffentlichen</button>
                    </form>
                </div>

                <div id="error-msg" style="color: #ff3b30; font-size: 0.85rem; margin-top: 20px; display: none; text-align: center; font-weight: 600; background: rgba(255, 59, 48, 0.1); padding: 12px; border-radius: 12px; line-height: 1.4;"></div>

            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    // --- DOM ELEMENTE ---
    const authSection = document.getElementById('auth-section');
    const authStepEmail = document.getElementById('auth-step-email');
    const authStepOtp = document.getElementById('auth-step-otp');
    const authStepProfile = document.getElementById('auth-step-profile');
    const listingSection = document.getElementById('listing-section');
    const errorDisplay = document.getElementById('error-msg');
    
    const inputEmail = document.getElementById('email') as HTMLInputElement;
    const inputOtp = document.getElementById('otp-code') as HTMLInputElement;
    const stepDot2 = document.getElementById('step-dot-2');
    const progressLine = document.getElementById('progress-line');

    // FEHLER LOGIK
    function showError(msg: string) {
        if (errorDisplay) {
            errorDisplay.innerText = msg;
            errorDisplay.style.display = 'block';
        }
    }
    function hideError() {
        if (errorDisplay) errorDisplay.style.display = 'none';
    }

    // --- 0. INITIALER SESSION CHECK ---
    async function checkExistingSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            const { data: profile } = await supabase
                .from('profiles')
                .select('has_completed_onboarding')
                .eq('id', session.user.id)
                .single();

            if (profile?.has_completed_onboarding) {
                showListingForm();
            } else {
                if(authStepEmail) authStepEmail.style.display = 'none';
                if(authStepProfile) authStepProfile.style.display = 'block';
            }
        }
    }
    checkExistingSession();

    // --- 1. OTP SENDEN ---
    document.getElementById('btn-send-otp')?.addEventListener('click', async (e) => {
        hideError();
        const email = inputEmail.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if(!emailRegex.test(email)) return showError("Bitte gib eine gültige E-Mail Adresse ein.");

        const btn = e.target as HTMLButtonElement;
        btn.disabled = true;
        btn.innerText = "Sende...";

        const { error } = await supabase.auth.signInWithOtp({ email });
        
        if (error) {
            showError("Fehler: " + error.message);
            btn.disabled = false;
            btn.innerText = "Code anfordern";
        } else {
            if(authStepEmail) authStepEmail.style.display = 'none';
            if(authStepOtp) authStepOtp.style.display = 'block';
            const info = document.getElementById('auth-info');
            if(info) info.innerText = "Prüfe dein Postfach!";
        }
    });

    // --- 2. OTP VERIFIZIEREN ---
    document.getElementById('btn-verify-otp')?.addEventListener('click', async (e) => {
        hideError();
        const email = inputEmail.value.trim();
        const token = inputOtp.value.trim();

        const btn = e.target as HTMLButtonElement;
        btn.innerText = "Prüfe...";
        btn.disabled = true;

        let { data, error } = await supabase.auth.verifyOtp({ email, token, type: 'email' });
        
        if (error) {
            const signupRes = await supabase.auth.verifyOtp({ email, token, type: 'signup' });
            data = signupRes.data;
            error = signupRes.error;
        }

        if (error || !data.user) {
            showError("Code ungültig oder abgelaufen.");
            btn.innerText = "Identität bestätigen";
            btn.disabled = false;
            return;
        }

        const { data: profile } = await supabase
            .from('profiles')
            .select('has_completed_onboarding')
            .eq('id', data.user.id)
            .single();

        if (profile?.has_completed_onboarding) {
            showListingForm();
        } else {
            if(authStepOtp) authStepOtp.style.display = 'none';
            if(authStepProfile) authStepProfile.style.display = 'block';
            const heading = document.getElementById('auth-heading');
            if(heading) heading.innerText = "Willkommen!";
        }
    });

    // --- 3. PROFIL SPEICHERN ---
    document.getElementById('btn-save-profile')?.addEventListener('click', async (e) => {
        hideError();
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return window.location.reload();

        const nickname = (document.getElementById('nickname') as HTMLInputElement).value.trim();
        const first_name = (document.getElementById('vorname') as HTMLInputElement).value.trim();
        const last_name = (document.getElementById('nachname') as HTMLInputElement).value.trim();

        // VALIDIERUNG
        const nicknameRegex = /^[a-zA-Z0-9_]{3,20}$/; 
        const nameRegex = /^[a-zA-ZÀ-ÿ\s\-]{2,30}$/;

        if (!nameRegex.test(first_name)) return showError("Vorname ungültig (Nur Buchstaben, 2-30 Zeichen).");
        if (!nameRegex.test(last_name)) return showError("Nachname ungültig (Nur Buchstaben, 2-30 Zeichen).");
        if (!nicknameRegex.test(nickname)) return showError("Nickname ungültig: 3-20 Zeichen, nur Buchstaben, Zahlen & Unterstrich.");

        const btn = e.target as HTMLButtonElement;
        btn.innerText = "Speichere...";
        btn.disabled = true;

        const { error } = await supabase.from('profiles').upsert({
            id: session.user.id,
            nickname,
            first_name,
            last_name,
            registered_email: session.user.email,
            has_completed_onboarding: true
        });

        if (error) {
            if (error.code === '23505') {
                showError("Dieser Nickname ist bereits vergeben.");
            } else {
                showError("Fehler: " + error.message);
            }
            btn.innerText = "Profil speichern & weiter";
            btn.disabled = false;
        } else {
            showListingForm();
        }
    });

    function showListingForm() {
        if(authSection) authSection.style.display = 'none';
        if(listingSection) listingSection.style.display = 'block';
        if(stepDot2) stepDot2.classList.add('active');
        if(progressLine) progressLine.style.background = '#00bcd4';
    }

    // --- 4. KATEGORIEN & DISTANZEN ---
    const categorySelect = document.getElementById('category') as HTMLSelectElement;
    const distanceSelect = document.getElementById('distance-select') as HTMLSelectElement;
    const distances = {
        Laufen: ['5 km', '10 km', 'Halbmarathon', 'Marathon', 'Ultra'],
        Radrennen: ['Jedermann (kurz)', 'Jedermann (lang)', 'RTF', 'Kriterium', 'Radmarathon'],
        Triathlon: ['Sprint', 'Olympisch', 'Mitteldistanz', 'Langdistanz'],
        Hyrox: ['Open Men/Women', 'Pro Men/Women', 'Doubles', 'Relay']
    };

    categorySelect?.addEventListener('change', () => {
        const selected = categorySelect.value as keyof typeof distances;
        if (distanceSelect) {
            distanceSelect.innerHTML = '';
            distances[selected].forEach(dist => {
                const opt = document.createElement('option');
                opt.value = dist; opt.textContent = dist;
                distanceSelect.appendChild(opt);
            });
        }
    });

    // --- 5. LISTING ABSENDEN ---
    document.getElementById('listing-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        const btn = document.getElementById('btn-final') as HTMLButtonElement;
        btn.disabled = true;
        btn.textContent = "Wird veröffentlicht...";

        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) throw new Error("Sitzung abgelaufen. Bitte lade die Seite neu.");

            const formData = new FormData(e.target as HTMLFormElement);
            const vals = Object.fromEntries(formData);

            const { error: insertError } = await supabase.from('listings').insert([{
                user_id: user.id, 
                vorname: (document.getElementById('vorname') as HTMLInputElement)?.value || "",
                nachname: (document.getElementById('nachname') as HTMLInputElement)?.value || "",
                seller_email: user.email,
                category: vals.category,
                event_name: vals.event_name,
                distance: vals.distance,
                event_date: vals.event_date,
                plz: vals.plz,
                location: (document.getElementById('location') as HTMLInputElement).value,
                price: parseFloat(vals.price as string),
                approved: true
            }]);

            if (insertError) throw insertError;

            // Erfolgsmeldung im Fehler-Banner (Grün umstylen für Erfolg)
            if (errorDisplay) {
                errorDisplay.style.background = "rgba(0, 188, 212, 0.1)";
                errorDisplay.style.color = "var(--cyan)";
                errorDisplay.innerText = "Erfolg! Dein Inserat ist online. Weiterleitung zum Dashboard...";
                errorDisplay.style.display = "block";
            }
            
            setTimeout(() => window.location.href = "/dashboard", 2000);

        } catch (err: any) {
            showError(err.message);
            btn.disabled = false;
            btn.textContent = "Inserat jetzt veröffentlichen";
        }
    });
</script>

<style>
    /* CSS BLEIBT IDENTISCH - NUR DIE ERROR-MSG WURDE GEADDET */
    :root { --cyan: #00bcd4; --bg: #323232; }
    
    .page-wrapper {
        min-height: 100vh;
        background: var(--bg);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 120px 20px 60px;
        color: white;
        font-family: system-ui, sans-serif;
    }

    .container {
        background: #111;
        width: 100%;
        max-width: 550px;
        padding: 40px;
        border-radius: 24px;
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .heading { font-size: 2rem; font-weight: 900; margin-bottom: 10px; color: white; text-align: center; }
    .info-text { color: #888; font-size: 0.9rem; line-height: 1.5; text-align: center; margin-bottom: 30px; }

    .progress-bar { display: flex; align-items: center; justify-content: center; margin-bottom: 40px; }
    .step { width: 32px; height: 32px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; color: #666; transition: 0.3s; }
    .step.active { background: var(--cyan); color: black; box-shadow: 0 0 15px rgba(0, 188, 212, 0.4); }
    .line { width: 40px; height: 2px; background: #333; margin: 0 10px; }

    .input-label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; margin-top: 15px; }
    .input { width: 100%; background: #000; border: 1px solid #333; padding: 15px; border-radius: 12px; color: white; font-size: 1rem; transition: 0.3s; box-sizing: border-box; outline: none; }
    .input:focus { border-color: var(--cyan); }
    
    .row { display: flex; gap: 15px; }
    .col { flex: 1; }

    .login-button { width: 100%; background: var(--cyan); color: black; border: none; padding: 16px; border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.3s; font-size: 1rem; margin-top: 25px; }
    .login-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 188, 212, 0.3); }
    .login-button:disabled { opacity: 0.5; cursor: not-allowed; }

    .price-input-wrapper { position: relative; }
    .currency-suffix { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--cyan); font-weight: 900; }
    .checkbox-wrapper { display: flex; gap: 10px; margin-top: 20px; font-size: 0.8rem; color: #666; align-items: center; }
</style>