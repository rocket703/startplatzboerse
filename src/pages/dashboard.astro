---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
import Popup from '../components/Popup.astro';
---

<Layout title="Mein Dashboard | startplatzboerse.com">
    <main class="dash-page">
        <div class="container">
            
            <header class="dash-hero">
                <div class="dash-layout-header">
                    <div class="card stats-main">
                        <div class="stats-content">
                            <span class="eyebrow">Dein Account</span>
                            <div class="count-row">
                                <h1 id="stats-count">0</h1>
                                <p>Aktive Inserate</p>
                            </div>
                        </div>
                        <div class="stats-nav">
                            <a href="/inserieren" class="btn-cyan-glow">＋ Neues Inserat</a>
                            <button id="logout-trigger" class="btn-logout-brand">Abmelden</button>
                        </div>
                    </div>

                    <div class="card inquiries-quick-access">
                        <div class="iq-header-top">
                            <h2 class="section-label" style="margin-bottom:0;">Nachrichten</h2>
                            <div class="tabs">
                                <button class="tab-btn active" id="tab-received">Erhalten</button>
                                <button class="tab-btn" id="tab-sent">Gesendet</button>
                            </div>
                        </div>
                        
                        <div id="inquiries-list" class="inquiry-compact-list">
                            </div>

                        <div id="no-inquiries" class="empty-state-compact" style="display: none;">
                            <p>Keine Nachrichten vorhanden.</p>
                        </div>
                    </div>
                </div>
            </header>

            <section class="listings-section">
                <h2 class="section-label">Deine aktiven Inserate</h2>
                
                <div id="auth-loader" class="loader-wrap">
                    <div class="spinner"></div>
                </div>

                <div id="listings-grid" class="grid">
                    </div>

                <div id="no-data" class="card empty-state" style="display: none;">
                    <h3>Hier ist es noch leer.</h3>
                    <p>Verkaufe jetzt deinen Startplatz und bringe andere an die Startlinie.</p>
                </div>
            </section>
        </div>

        <div id="edit-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content card">
                <div class="modal-header">
                    <h3>Preis anpassen</h3>
                    <button id="close-modal" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <label for="new-price">Neuer Preis in €</label>
                    <div class="input-wrapper">
                        <input type="number" id="new-price" placeholder="45">
                        <span class="currency-label">€</span>
                    </div>
                    <input type="hidden" id="edit-listing-id">
                    <p class="hint">Dein Inserat wird sofort aktualisiert.</p>
                </div>
                <div class="modal-footer">
                    <button id="save-price" class="btn-cyan-glow" style="width:100%;">Preis aktualisieren</button>
                </div>
            </div>
        </div>

        <Popup id="status-popup" title="Systemmeldung">
            <p id="popup-text" style="color: #ccc; margin-bottom: 20px;"></p>
            <div style="display: flex; gap: 10px;">
                <button class="login-button" style="background: #333; flex:1;" onclick="document.getElementById('status-popup').style.display='none'">Abbrechen</button>
                <button id="confirm-delete-btn" class="login-button" style="display: none; background: #ff3b30; flex:1;" onclick="window.realDelete()">Endgültig löschen</button>
            </div>
        </Popup>

    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    let deleteId = null;
    let receivedData = [];
    let sentData = [];

    function showPopup(title, message) {
        const popup = document.getElementById('status-popup');
        const titleEl = popup?.querySelector('h3');
        const textEl = document.getElementById('popup-text');
        if (popup && titleEl && textEl) {
            titleEl.innerText = title;
            textEl.innerText = message;
            popup.style.display = 'flex';
        }
    }

    async function initDashboard() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return window.location.href = "/login";

        // Daten laden
        const [listingsRes, receivedRes, sentRes] = await Promise.all([
            supabase.from('listings').select('*').eq('user_id', user.id).order('created_at', { ascending: false }),
            supabase.from('inquiries').select('*, listings(event_name)').eq('seller_id', user.id).order('created_at', { ascending: false }),
            supabase.from('inquiries').select('*, listings(event_name)').eq('buyer_id', user.id).order('created_at', { ascending: false })
        ]);

        receivedData = receivedRes.data || [];
        sentData = sentRes.data || [];

        document.getElementById('auth-loader').style.display = 'none';
        document.getElementById('stats-count').innerText = listingsRes.data?.length.toString() || "0";

        renderListings(listingsRes.data);
        renderInquiries(receivedData, 'received');

        // Tab Handler
        document.getElementById('tab-received')?.addEventListener('click', () => {
            document.getElementById('tab-received').classList.add('active');
            document.getElementById('tab-sent').classList.remove('active');
            renderInquiries(receivedData, 'received');
        });
        document.getElementById('tab-sent')?.addEventListener('click', () => {
            document.getElementById('tab-sent').classList.add('active');
            document.getElementById('tab-received').classList.remove('active');
            renderInquiries(sentData, 'sent');
        });
    }

    function renderListings(items) {
        const grid = document.getElementById('listings-grid');
        if (!items || items.length === 0) {
            document.getElementById('no-data').style.display = 'block';
            return;
        }
        grid.innerHTML = items.map(item => `
            <article class="card event-card">
                <div class="card-body-content">
                    <div class="card-meta">
                        <span class="cat">${item.category}</span>
                        <span class="date">${new Date(item.event_date).toLocaleDateString('de-DE')}</span>
                    </div>
                    <h2>${item.event_name}</h2>
                    <p class="loc">${item.location} • ${item.distance || ''}</p>
                    <div class="price-box">
                        ${item.old_price ? `<span class="old-price">${item.old_price}€</span>` : ''}
                        <span class="amt">${item.price}€</span>
                    </div>
                </div>
                <div class="mgmt-actions">
                    <button class="btn-mgmt edit" onclick="window.openEditModal('${item.id}', '${item.price}')">Bearbeiten</button>
                    <button class="btn-mgmt delete" onclick="window.askDelete('${item.id}')">Löschen</button>
                </div>
            </article>
        `).join('');
    }

    function renderInquiries(items, type) {
        const list = document.getElementById('inquiries-list');
        const empty = document.getElementById('no-inquiries');
        if (!items || items.length === 0) {
            list.innerHTML = '';
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';
        list.innerHTML = items.map(iq => `
            <a href="mailto:${type === 'received' ? iq.buyer_email : iq.buyer_email}?subject=Anfrage: ${iq.listings?.event_name}" class="inquiry-card-compact" style="text-decoration:none;">
                <div class="iq-meta-compact">
                    <span style="color:var(--cyan); font-weight:800;">${iq.listings?.event_name || 'Event'}</span>
                    <span>${new Date(iq.created_at).toLocaleDateString('de-DE')}</span>
                </div>
                <span class="iq-name-compact">${type === 'received' ? 'Von: ' : 'An: '}${iq.buyer_name}</span>
                <p class="iq-msg-compact">${iq.message}</p>
            </a>
        `).join('');
    }

    // Window Actions
    window.openEditModal = (id, price) => {
        document.getElementById('edit-listing-id').value = id;
        document.getElementById('new-price').value = price;
        document.getElementById('edit-modal').style.display = 'flex';
    };

    window.askDelete = (id) => {
        deleteId = id;
        document.getElementById('confirm-delete-btn').style.display = 'block';
        showPopup("Löschen?", "Willst du das Inserat wirklich entfernen?");
    };

    window.realDelete = async () => {
        await supabase.from('listings').delete().eq('id', deleteId);
        location.reload();
    };

    document.getElementById('close-modal').onclick = () => document.getElementById('edit-modal').style.display = 'none';
    
    document.getElementById('save-price').onclick = async () => {
        const id = document.getElementById('edit-listing-id').value;
        const price = document.getElementById('new-price').value;
        const { data: old } = await supabase.from('listings').select('price').eq('id', id).single();
        await supabase.from('listings').update({ price, old_price: old.price }).eq('id', id);
        location.reload();
    };

    document.getElementById('logout-trigger').onclick = async () => {
        await supabase.auth.signOut();
        location.href = "/";
    };

    initDashboard();
</script>

<style is:global>
    :root { --bg: #050505; --bg-card: #111; --cyan: #00bcd4; --danger: #ff3b30; }
    .dash-page { background: var(--bg); min-height: 100vh; padding: 120px 20px 80px; color: white; font-family: 'Inter', sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* Header Layout */
    .dash-layout-header { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 50px; }
    
    .card { background: var(--bg-card); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); }

    /* Stats */
    .stats-main { display: flex; flex-direction: column; justify-content: space-between; }
    .count-row { display: flex; align-items: baseline; gap: 15px; margin: 10px 0 20px; }
    .count-row h1 { font-size: 4rem; color: var(--cyan); font-weight: 900; }
    .stats-nav { display: flex; gap: 10px; }

    /* Inquiries Quick Access */
    .inquiries-quick-access { display: flex; flex-direction: column; max-height: 320px; }
    .iq-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .inquiry-compact-list { overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .inquiry-card-compact { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; transition: 0.2s; }
    .inquiry-card-compact:hover { border-color: var(--cyan); background: rgba(0, 188, 212, 0.05); }
    .iq-meta-compact { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 5px; }
    .iq-name-compact { font-weight: 800; font-size: 0.85rem; color: #fff; display: block; }
    .iq-msg-compact { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Tabs */
    .tabs { display: flex; gap: 5px; background: #000; padding: 4px; border-radius: 12px; }
    .tab-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; color: #555; border: none; background: transparent; cursor: pointer; }
    .tab-btn.active { background: var(--cyan); color: #000; }

    /* Listings Grid */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .event-card { display: flex; flex-direction: column; height: 100%; }
    .card-meta { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 800; margin-bottom: 15px; }
    .cat { color: var(--cyan); text-transform: uppercase; }
    .event-card h2 { font-size: 1.5rem; font-weight: 900; line-height: 1.1; margin-bottom: 10px; }
    .loc { color: #666; font-size: 0.9rem; }
    .price-box { margin-top: 20px; display: flex; align-items: baseline; gap: 10px; }
    .amt { font-size: 2.2rem; font-weight: 900; color: var(--cyan); }
    .old-price { text-decoration: line-through; color: #444; }

    .mgmt-actions { margin-top: auto; padding-top: 20px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.05); }
    .btn-mgmt { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
    .btn-mgmt.edit { background: rgba(0, 188, 212, 0.1); color: var(--cyan); }
    .btn-mgmt.delete { background: rgba(255, 255, 255, 0.03); color: #444; }

    .btn-cyan-glow { background: var(--cyan); color: #000; padding: 12px 24px; border-radius: 14px; font-weight: 800; text-decoration: none; display: inline-block; text-align: center; border:none; cursor:pointer;}
    .btn-logout-brand { background: transparent; border: 1px solid #222; color: #444; padding: 12px 20px; border-radius: 14px; cursor: pointer; font-weight: 700; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { max-width: 400px; width: 100%; }
    #new-price { width: 100%; background: #000; border: 1px solid #222; padding: 15px; border-radius: 12px; color: #fff; font-size: 1.5rem; font-weight: 800; }

    @media (max-width: 900px) { .dash-layout-header { grid-template-columns: 1fr; } }
</style>