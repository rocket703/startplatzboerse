---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Mein Dashboard | startplatzboerse.com">
    <main class="dash-page">
        <div class="container">
            
            <header class="dash-hero">
                <div class="card stats-main">
                    <div class="stats-content">
                        <span class="eyebrow">Dein Account</span>
                        <div class="count-row">
                            <h1 id="stats-count">0</h1>
                            <p>Aktive Inserate</p>
                        </div>
                    </div>
                    <div class="stats-nav">
                        <a href="/inserieren" class="btn-cyan-glow">＋ Neues Inserat</a>
                        <button id="logout-trigger" class="btn-logout-brand">Abmelden</button>
                    </div>
                </div>
            </header>

            <section class="listings-section">
                <h2 class="section-label">Deine Inserate</h2>
                
                <div id="auth-loader" class="loader-wrap">
                    <div class="spinner"></div>
                </div>

                <div id="listings-grid" class="grid">
                    </div>

                <div id="no-data" class="card empty-state" style="display: none;">
                    <h3>Hier ist es noch leer.</h3>
                    <p>Verkaufe jetzt deinen Startplatz und bringe andere an die Startlinie.</p>
                </div>
            </section>
        </div>

        <div id="edit-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content card">
                <div class="modal-header">
                    <h3>Preis anpassen</h3>
                    <button id="close-modal" class="btn-close">✕</button>
                </div>
                <div class="modal-body">
                    <label for="new-price">Neuer Preis in €</label>
                    <div class="input-wrapper">
                        <input type="number" id="new-price" placeholder="45">
                        <span class="currency-label">€</span>
                    </div>
                    <input type="hidden" id="edit-listing-id">
                    <p class="hint">Dein Inserat wird sofort aktualisiert.</p>
                </div>
                <div class="modal-footer">
                    <button id="save-price" class="btn-cyan-glow">Preis aktualisieren</button>
                </div>
            </div>
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    async function initDashboard() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return window.location.href = "/login";

        const { data: listings } = await supabase
            .from('listings')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

        document.getElementById('auth-loader')!.style.display = 'none';
        document.getElementById('stats-count')!.innerText = listings?.length.toString() || "0";

        const grid = document.getElementById('listings-grid');
        if (!listings || listings.length === 0) {
            document.getElementById('no-data')!.style.display = 'block';
            return;
        }

        grid!.innerHTML = listings.map(item => `
            <article class="card event-card">
                <div class="card-body-content">
                    <div class="card-meta">
                        <span class="cat">${item.category}</span>
                        <span class="date">${item.event_date ? new Date(item.event_date).toLocaleDateString('de-DE') : ''}</span>
                    </div>
                    <h2>${item.event_name}</h2>
                    <p class="loc">${item.location} • ${item.distance || ''}</p>
                    
                    <div class="price-box">
                        ${item.old_price && Number(item.old_price) > Number(item.price) 
                            ? `<span class="old-price">${item.old_price}€</span>` 
                            : ''
                        }
                        <span class="amt">${item.price}€</span>
                    </div>
                </div>
                
                <div class="mgmt-actions">
                    <button class="btn-mgmt edit" onclick="window.openEditModal('${item.id}', '${item.price}')">Bearbeiten</button>
                    <button class="btn-mgmt delete" onclick="window.confirmDel('${item.id}')">Löschen</button>
                </div>
            </article>
        `).join('');
    }

    // Modal Logik
    const modal = document.getElementById('edit-modal');
    window.openEditModal = (id, currentPrice) => {
        (document.getElementById('edit-listing-id') as HTMLInputElement).value = id;
        (document.getElementById('new-price') as HTMLInputElement).value = currentPrice;
        modal!.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };

    document.getElementById('close-modal')?.addEventListener('click', () => {
        modal!.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    document.getElementById('save-price')?.addEventListener('click', async () => {
        const id = (document.getElementById('edit-listing-id') as HTMLInputElement).value;
        const newPrice = Number((document.getElementById('new-price') as HTMLInputElement).value);
        
        const { data: current } = await supabase.from('listings').select('price').eq('id', id).single();
        
        const { error } = await supabase
            .from('listings')
            .update({ 
                price: newPrice, 
                old_price: current?.price 
            })
            .eq('id', id);

        if (error) {
            alert("Fehler beim Speichern: " + error.message);
        } else {
            location.reload();
        }
    });

    document.getElementById('logout-trigger')?.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = "/";
    });

    window.confirmDel = async (id: string) => {
        if (confirm("Möchtest du diesen Startplatz wirklich entfernen?")) {
            await supabase.from('listings').delete().eq('id', id);
            location.reload();
        }
    };

    initDashboard();
</script>

<style is:global>
    :root {
        --bg: #050505;
        --bg-card: #111111;
        --cyan: #00bcd4;
        --danger: #ff3b30;
        --font-h1: clamp(2.8rem, 12vw, 4.8rem);
        --font-h2: clamp(1.4rem, 5vw, 1.9rem);
    }

    .dash-page { background: var(--bg); min-height: 100vh; padding: 140px 20px 80px; color: white; font-family: 'Inter', sans-serif; }
    .container { max-width: 1100px; margin: 0 auto; }

    /* KARTEN DESIGN BASIS */
    .card {
        background: var(--bg-card);
        padding: clamp(25px, 5vw, 40px) clamp(20px, 4vw, 30px);
        border-radius: 24px;
        border: 5px solid rgba(255,255,255,0.05);
        transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    /* GRID */
    .grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); 
        gap: 25px; 
        align-items: stretch; /* Stretcht Karten in einer Reihe auf gleiche Höhe */
    }

    /* EVENT CARD SPEZIFISCH */
    .event-card {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .card-body-content {
        flex-grow: 1; /* Nimmt allen verfügbaren Platz ein und drückt Buttons nach unten */
        display: flex;
        flex-direction: column;
    }

    .mgmt-actions {
        margin-top: 30px;
        display: flex;
        gap: 12px;
        border-top: 1px solid rgba(255,255,255,0.05);
        padding-top: 25px;
    }

    /* TYPO & PRICE */
    .card-meta { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 0.75rem; font-weight: 800; }
    .cat { color: var(--cyan); text-transform: uppercase; }
    .date { color: #444; }
    .event-card h2 { font-size: var(--font-h2); font-weight: 900; margin-bottom: 8px; letter-spacing: -0.5px; line-height: 1.1; }
    .loc { font-size: 0.95rem; color: #888; margin-bottom: 15px; }
    
    .price-box { display: flex; align-items: baseline; gap: 12px; margin-top: auto; padding-bottom: 5px; }
    .old-price { font-size: 1.1rem; color: #444; text-decoration: line-through; font-weight: 600; }
    .amt { font-size: 2.2rem; font-weight: 900; color: var(--cyan); }

    /* BUTTONS & REST */
    .btn-mgmt { flex: 1; padding: 14px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
    .btn-mgmt.edit { background: rgba(0, 188, 212, 0.1); color: var(--cyan); }
    .btn-mgmt.delete { background: rgba(255, 255, 255, 0.03); color: #444; }
    .btn-mgmt.delete:hover { background: rgba(255, 59, 48, 0.1); color: var(--danger); }

    .btn-cyan-glow { background: var(--cyan); color: black; padding: 16px 32px; border-radius: 18px; text-decoration: none; font-weight: 800; border: none; cursor: pointer; }
    .btn-logout-brand { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: #555; padding: 16px 24px; border-radius: 18px; cursor: pointer; font-weight: 700; transition: 0.3s; }
    .btn-logout-brand:hover { color: var(--danger); border-color: var(--danger); }

    /* MODAL STYLES */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
    .modal-content { max-width: 420px; width: 100%; border-color: rgba(0, 188, 212, 0.4); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .btn-close { background: none; border: none; color: #444; font-size: 1.5rem; cursor: pointer; }
    .input-wrapper { position: relative; margin: 15px 0; }
    #new-price { width: 100%; background: #000; border: 2px solid #222; padding: 18px; border-radius: 16px; color: white; font-size: 1.8rem; font-weight: 900; }
    .currency-label { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-weight: 900; color: var(--cyan); font-size: 1.2rem; }

    /* HERO & LOADERS */
    .dash-hero { margin-bottom: 60px; }
    .stats-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 30px; }
    .stats-main h1 { font-size: var(--font-h1); font-weight: 900; line-height: 1; margin: 5px 0; color: var(--cyan); }
    .count-row { display: flex; align-items: baseline; gap: 15px; }
    .count-row p { color: #555; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
    .stats-nav { display: flex; gap: 15px; }
    .section-label { font-size: 0.8rem; text-transform: uppercase; color: #222; letter-spacing: 3px; margin-bottom: 30px; font-weight: 900; }
    .loader-wrap { text-align: center; padding: 80px; }
    .spinner { width: 35px; height: 35px; border: 4px solid rgba(255,255,255,0.05); border-top-color: var(--cyan); border-radius: 50%; animation: spin 1s infinite linear; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 650px) {
        .stats-main { padding: 30px; text-align: center; justify-content: center; }
        .stats-nav { width: 100%; flex-direction: column; }
        .grid { grid-template-columns: 1fr; }
    }
    .hint {
    font-size: 0.8rem;         
    color: #888;               
    line-height: 1.5;          
    margin-top: 15px;     
    font-weight: 400;   
    letter-spacing: 0.02em;   
    opacity: 0.8;            
}
</style>