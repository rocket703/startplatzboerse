---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
import Popup from '../components/Popup.astro';
---

<Layout title="Dashboard | startplatzboerse.com">
    <main class="dash-page">
        <div class="container">
            
            <header class="dash-header-new">
                <div class="user-greeting">
                    <span class="eyebrow">Willkommen zurück</span>
                    <h1 id="user-name-display">Dein Dashboard</h1>
                </div>
                <div class="header-stats-pill">
                    <div class="stat-group">
                        <span id="stats-count">0</span>
                        <label>Inserate</label>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-group">
                        <span id="watchlist-count">0</span>
                        <label>Gemerkt</label>
                    </div>
                </div>
            </header>

            <div class="quick-actions">
                <a href="/inserieren" class="action-btn primary">
                    <span class="icon">＋</span> Inserat erstellen
                </a>
                <button id="logout-trigger" class="action-btn secondary">
                    Abmelden
                </button>
            </div>

            <nav class="dash-nav-pills">
                <button class="nav-pill active" data-target="section-listings">Anzeigen</button>
                <button class="nav-pill" data-target="section-messages">Chats</button>
                <button class="nav-pill" data-target="section-watchlist">Merkliste</button>
            </nav>

            <div class="dash-content">
                
                <section id="section-listings" class="dash-section active">
                    <div id="listings-grid" class="smart-grid"></div>
                    <div id="no-listings" class="empty-state" style="display:none;">
                        <p>Noch keine Inserate online.</p>
                    </div>
                </section>

                <section id="section-messages" class="dash-section">
                    <div id="inquiries-feed" class="message-stack"></div>
                    <div id="no-inquiries" class="empty-state" style="display:none;">
                        <p>Keine aktiven Chats vorhanden.</p>
                    </div>
                </section>

                <section id="section-watchlist" class="dash-section">
                    <div id="watchlist-grid" class="smart-grid">
                        <div class="card glass-card">
                            <p style="color:#666">Demnächst verfügbar: Merke dir Inserate für später.</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <Popup id="status-popup" title="Info">
            <div id="popup-dynamic-content"></div>
            <div id="popup-actions" class="modal-footer-btns">
                <button class="btn-close-modal" onclick="document.getElementById('status-popup').style.display='none'">Schließen</button>
                <button id="confirm-action-btn" class="btn-action-main" style="display:none;"></button>
            </div>
        </Popup>

        <div id="edit-modal" class="modal-overlay" style="display:none;">
            <div class="modal-content glass-card">
                <h3>Preis anpassen</h3>
                <div class="input-glow-wrap">
                    <input type="number" id="new-price" placeholder="0">
                    <span>€</span>
                </div>
                <input type="hidden" id="edit-listing-id">
                <div class="modal-footer-btns">
                    <button onclick="document.getElementById('edit-modal').style.display='none'" class="btn-close-modal">Abbrechen</button>
                    <button id="save-price" class="btn-action-main">Speichern</button>
                </div>
            </div>
        </div>

    </main>
    <Footer />
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    let deleteId = null;

    async function init() {
        console.log("Dashboard Init gestartet...");

        // 1. AUTH CHECK
        const { data: { user }, error: authError } = await supabase.auth.getUser();

        if (authError || !user) {
            window.location.href = "/login";
            return;
        }

        // 2. DATEN LADEN (Wir machen beides gleichzeitig für mehr Speed)
        // Wir nutzen die Funktionen von unten
        await Promise.all([
            fetchListings(user.id),
            fetchChats(user.id)
        ]);

        // 3. TABS INITIALISIEREN
        setupTabs();

        // 4. AUTO-WECHSEL ZU CHATS (Falls man gerade eine Nachricht gesendet hat)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('chat_id')) {
            const chatPill = document.querySelector('[data-target="section-messages"]');
            if (chatPill) {
                console.log("Auto-Wechsel zum Chat-Tab");
                (chatPill as HTMLElement).click();
            }
        }

        // Logout Event
        document.getElementById('logout-trigger')?.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = "/";
        });
    }

    // --- HILFSFUNKTIONEN ---

    async function fetchListings(userId) {
        const grid = document.getElementById('listings-grid');
        const empty = document.getElementById('no-listings');

        const { data, error } = await supabase
            .from('listings')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', {ascending: false});

        if (error) {
            console.error("Fehler Inserate:", error);
            return;
        }

        document.getElementById('stats-count').innerText = data.length || 0;

        if (!data || data.length === 0) {
            if(empty) empty.style.display = 'block';
            return;
        }
        
        grid.innerHTML = data.map(item => `
            <div class="glass-card event-card-new">
                <div class="card-content">
                    <span class="eyebrow">${item.category || 'Event'}</span>
                    <h3>${item.event_name}</h3>
                    <p style="color:#666; font-size:0.8rem;">${new Date(item.event_date).toLocaleDateString()}</p>
                    <div class="price-tag-new">${item.price}€</div>
                </div>
                <div class="card-footer-btns">
                    <button class="btn-small edit" onclick="window.openEditModal('${item.id}', '${item.price}')">Preis</button>
                    <button class="btn-small" onclick="window.askDelete('${item.id}')">Löschen</button>
                </div>
            </div>
        `).join('');
    }

    async function fetchChats(userId) {
        const feed = document.getElementById('inquiries-feed');
        const empty = document.getElementById('no-inquiries');

        const { data: chats, error } = await supabase
            .from('conversations')
            .select(`
                id, 
                updated_at, 
                listing_id, 
                buyer_id, 
                seller_id,
                listings (event_name)
            `)
            .or(`buyer_id.eq.${userId},seller_id.eq.${userId}`)
            .order('updated_at', { ascending: false });

        if (error || !chats || chats.length === 0) {
            if(empty) empty.style.display = 'block';
            return;
        }

        feed.innerHTML = chats.map(chat => {
            const isBuyer = chat.buyer_id === userId;
            const badgeClass = isBuyer ? 'received' : 'sent';
            const roleLabel = isBuyer ? 'DU KAUFST' : 'DU VERKAUFST';
            const eventName = chat.listings?.event_name || 'Unbekanntes Event';
            
            return `
                <div class="msg-card ${badgeClass}" onclick="window.location.href='/chat?id=${chat.id}'">
                    <div class="msg-header">
                        <span class="badge ${badgeClass}">${roleLabel}</span>
                        <span class="date">${new Date(chat.updated_at).toLocaleDateString()}</span>
                    </div>
                    <span class="msg-title">${eventName}</span>
                    <p class="msg-preview">Zum Chat →</p>
                </div>
            `;
        }).join('');
    }

    function setupTabs() {
        document.querySelectorAll('.nav-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                document.querySelectorAll('.nav-pill').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.dash-section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                const targetEl = document.getElementById(target);
                if (targetEl) targetEl.classList.add('active');
            });
        });
    }

    // --- WINDOW GLOBALS FÜR BUTTONS ---
    window.askDelete = (id) => {
        deleteId = id;
        document.getElementById('popup-dynamic-content').innerHTML = "Soll das Inserat gelöscht werden?";
        const btn = document.getElementById('confirm-action-btn');
        btn.style.display = 'block';
        btn.innerText = "Löschen";
        btn.style.background = "red";
        btn.onclick = async () => {
            await supabase.from('listings').delete().eq('id', deleteId);
            location.reload();
        };
        document.getElementById('status-popup').style.display = 'flex';
    }

    window.openEditModal = (id, price) => {
        document.getElementById('edit-listing-id').value = id;
        document.getElementById('new-price').value = price;
        document.getElementById('edit-modal').style.display = 'flex';
    }

    document.getElementById('save-price')?.addEventListener('click', async () => {
        const id = (document.getElementById('edit-listing-id') as HTMLInputElement).value;
        const price = (document.getElementById('new-price') as HTMLInputElement).value;
        await supabase.from('listings').update({ price }).eq('id', id);
        location.reload();
    });

    // START!
    init();
</script>
<style is:global>
    :root {
        --cyan: #00bcd4;
        --bg: #050505;
        --card-bg: #111;
        --glass: rgba(255, 255, 255, 0.03);
        --border: rgba(255, 255, 255, 0.08);
    }

    .dash-page { background: var(--bg); min-height: 100vh; padding: 100px 15px 40px; color: white; }
    .container { max-width: 1000px; margin: 0 auto; }

    /* --- HEADER NEW --- */
    .dash-header-new {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 30px;
    }

    @media (min-width: 768px) {
        .dash-header-new { flex-direction: row; justify-content: space-between; align-items: center; }
    }

    .user-greeting h1 { font-size: 2rem; font-weight: 900; letter-spacing: -1px; margin-top: 5px; }
    .eyebrow { color: var(--cyan); font-weight: 800; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; }

    .header-stats-pill {
        display: flex;
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 15px 25px;
        border-radius: 20px;
        gap: 20px;
        width: fit-content;
    }

    .stat-group { display: flex; flex-direction: column; align-items: center; }
    .stat-group span { font-size: 1.4rem; font-weight: 900; color: var(--cyan); line-height: 1.2; }
    .stat-group label { font-size: 0.65rem; color: #555; text-transform: uppercase; font-weight: 800; }
    .stat-divider { width: 1px; background: var(--border); height: 30px; }

    /* --- ACTIONS & NAV --- */
    .quick-actions { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 30px; }
    .action-btn { 
        padding: 16px; border-radius: 18px; border: none; font-weight: 800; 
        cursor: pointer; text-decoration: none; text-align: center; font-size: 0.9rem;
        transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .action-btn.primary { background: var(--cyan); color: #000; box-shadow: 0 10px 25px rgba(0, 188, 212, 0.2); }
    .action-btn.secondary { background: var(--card-bg); color: #666; border: 1px solid var(--border); }

    .dash-nav-pills { 
        display: flex; gap: 8px; margin-bottom: 30px; 
        overflow-x: auto; padding-bottom: 10px; scrollbar-width: none;
    }
    .nav-pill {
        background: transparent; border: 1px solid var(--border); color: #444;
        padding: 10px 20px; border-radius: 100px; white-space: nowrap;
        font-weight: 700; font-size: 0.85rem; cursor: pointer;
    }
    .nav-pill.active { background: var(--cyan); color: #000; border-color: var(--cyan); }

    /* --- SECTIONS --- */
    .dash-section { display: none; }
    .dash-section.active { display: block; animation: slideIn 0.4s ease forwards; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* --- CARDS (NEW) --- */
    .smart-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
    @media (min-width: 768px) { .smart-grid { grid-template-columns: 1fr 1fr; } }

    .glass-card { 
        background: var(--card-bg); border: 1px solid var(--border); 
        padding: 20px; border-radius: 24px; position: relative;
    }

    .event-card-new { display: flex; flex-direction: column; gap: 15px; }
    .event-card-new h3 { font-size: 1.3rem; font-weight: 800; line-height: 1.2; margin: 0; }
    .price-tag-new { font-size: 1.8rem; font-weight: 900; color: var(--cyan); }
    
    .card-footer-btns { display: flex; gap: 10px; margin-top: 10px; }
    .btn-small { 
        flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--border);
        background: rgba(255,255,255,0.02); color: #888; font-weight: 700; font-size: 0.8rem; cursor: pointer;
    }
    .btn-small.edit { color: var(--cyan); }

    /* --- MESSAGE STACK --- */
    .message-stack { display: flex; flex-direction: column; gap: 10px; }
    .msg-card { 
        padding: 15px 20px; border-radius: 20px; border: 1px solid var(--border); 
        background: var(--card-bg); cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; gap: 5px;
    }
    
    /* Farben für die Chat-Karten */
    .msg-card.received { border-left: 4px solid var(--cyan); } /* Ich bin Käufer */
    .msg-card.sent { opacity: 0.8; border-left: 4px solid #444; } /* Ich bin Verkäufer */
    
    .msg-card:hover { background: #161616; border-color: #333; }

    .msg-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; margin-bottom: 5px; }
    
    /* Badges */
    .badge { padding: 4px 8px; border-radius: 6px; font-weight: 900; letter-spacing: 1px; }
    .badge.received { background: rgba(0, 188, 212, 0.1); color: var(--cyan); }
    .badge.sent { background: #222; color: #888; }
    
    .msg-title { font-weight: 800; display: block; font-size: 1rem; }
    .msg-preview { font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- MODALS --- */
    .modal-overlay { 
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000;
        display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-footer-btns { display: flex; gap: 10px; margin-top: 20px; }
    .btn-close-modal { flex: 1; padding: 14px; border-radius: 14px; background: #1a1a1a; border: none; color: #666; font-weight: 700; cursor: pointer; }
    .btn-action-main { flex: 1.5; padding: 14px; border-radius: 14px; background: var(--cyan); border: none; color: #000; font-weight: 900; cursor: pointer; }
    
    /* Edit Modal Special */
    .input-glow-wrap { display: flex; align-items: center; justify-content: center; position: relative; margin: 20px 0; }
    #new-price { background: transparent; border: none; color: white; font-size: 3rem; font-weight: 900; width: 100%; text-align: center; outline: none; }
    .input-glow-wrap span { font-size: 2rem; color: var(--cyan); font-weight: 900; position: absolute; right: 20px; }
</style>