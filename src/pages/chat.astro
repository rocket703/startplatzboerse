---
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="Chat | startplatzboerse.com">
    <main class="chat-wrapper">
        <div class="chat-container">
            
            <header class="chat-sub-header glass-card">
                <a href="/dashboard" class="back-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg>
                </a>
                <div class="partner-info">
                    <span id="chat-event-name" class="eyebrow">Event</span>
                    <h2 id="chat-partner-name">Partner</h2>
                </div>
            </header>

            <div class="chat-window" id="chat-window">
                <div id="loader" class="loader">
                    <div class="spinner"></div>
                </div>
                </div>

            <footer class="chat-input-bar glass-card">
                <form id="chat-form">
                    <input 
                        type="text" 
                        id="msg-input" 
                        placeholder="Deine Nachricht..." 
                        autocomplete="off"
                        enterkeyhint="send"
                    >
                    <button type="submit" id="send-btn">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </form>
            </footer>

        </div>
    </main>
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get('id');
    let currentUser = null;

    async function initChat() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return window.location.href = '/login';
        currentUser = user;

        // 1. Daten laden
        const [infoRes, msgsRes] = await Promise.all([
            supabase.from('conversations').select('*, listings(event_name)').eq('id', conversationId).single(),
            supabase.from('messages').select('*').eq('conversation_id', conversationId).order('created_at', { ascending: true })
        ]);

        if (infoRes.data) {
            document.getElementById('chat-event-name').innerText = infoRes.data.listings?.event_name || "Event";
            document.getElementById('chat-partner-name').innerText = infoRes.data.buyer_id === user.id ? "Verkäufer" : "Käufer";
        }

        if (msgsRes.data) {
            const loader = document.getElementById('loader');
            if(loader) loader.style.display = 'none';
            msgsRes.data.forEach(msg => appendMessage(msg));
            scrollToBottom();
        }

        // 2. REALTIME: Für Nachrichten von anderen
        supabase.channel(`chat-${conversationId}`)
            .on('postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'messages', filter: `conversation_id=eq.${conversationId}` }, 
                payload => {
                    // Wir fügen es nur an, wenn es nicht von uns selbst kommt (da wir es im Submit-Handler schon tun)
                    if (payload.new.sender_id !== currentUser.id) {
                        appendMessage(payload.new);
                    }
                }
            )
            .subscribe();
    }

    function appendMessage(msg) {
        const container = document.getElementById('chat-window');
        // Sicherheits-Check: Falls Nachricht schon da ist (z.B. durch schnelles Realtime + Manuellem Append)
        if (!container || document.getElementById(`msg-${msg.id}`)) return;

        const isMe = msg.sender_id === currentUser.id;
        const time = msg.created_at 
            ? new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            : "Gerade eben";
        
        const div = document.createElement('div');
        div.id = `msg-${msg.id || Date.now()}`; // Fallback ID falls noch nicht generiert
        div.className = `bubble-wrapper ${isMe ? 'me' : 'other'}`;
        div.innerHTML = `
            <div class="bubble">
                <p>${msg.content}</p>
                <span class="time">${time}</span>
            </div>
        `;
        container.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        const win = document.getElementById('chat-window');
        if(win) win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
    }

    // FORMULAR-HANDLING (Der Teil hat gefehlt!)
    const form = document.getElementById('chat-form');
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('msg-input') as HTMLInputElement;
        const text = input.value.trim();
        if (!text) return;

        input.value = ""; // Feld sofort leeren für besseres Gefühl

        // Nachricht senden UND das Ergebnis direkt abfangen
        const { data, error } = await supabase
            .from('messages')
            .insert({
                conversation_id: conversationId,
                sender_id: currentUser.id,
                content: text
            })
            .select() // WICHTIG: Damit bekommen wir die ID und Zeitstempel zurück
            .single();

        if (error) {
            console.error("Senden fehlgeschlagen:", error);
            alert("Nachricht konnte nicht gesendet werden.");
        } else if (data) {
            // SOFORT im UI anzeigen
            appendMessage(data);
        }
    });

    initChat();
</script>

<style>
    :root {
        --cyan: #00bcd4;
        --bg: #050505;
        --card: #121212;
    }

    /* WICHTIG: Die Seite selbst soll nicht scrollen */
    html, body {
        overflow: hidden;
        height: 100%;
        margin: 0;
        background: var(--bg);
    }

    /* Wrapper sorgt für den Abstand zum Haupt-Header */
    .chat-wrapper {
        height: 100vh;
        padding-top: 85px; /* <--- HIER DEN ABSTAND FÜR DEINEN HEADER ANPASSEN */
        display: flex;
        justify-content: center;
        background: var(--bg);
    }

    .chat-container {
        width: 100%;
        max-width: 600px;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    /* Sub-Header (Partner-Info) */
    .chat-sub-header {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        gap: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        background: rgba(10, 10, 10, 0.8);
        backdrop-filter: blur(15px);
    }

    .back-btn { color: #888; display: flex; align-items: center; transition: 0.2s; }
    .back-btn:hover { color: white; }
    
    .eyebrow { font-size: 0.6rem; color: var(--cyan); text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
    .partner-info h2 { font-size: 1rem; margin: 0; font-weight: 800; color: white; }

    /* Fenster */
    .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 20px 15px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scrollbar-width: none;
    }
    .chat-window::-webkit-scrollbar { display: none; }

    /* Bubbles */
    .bubble-wrapper { display: flex; width: 100%; }
    .bubble-wrapper.me { justify-content: flex-end; }
    .bubble-wrapper.other { justify-content: flex-start; }

    .bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .me .bubble {
        background: var(--cyan);
        color: black;
        border-bottom-right-radius: 4px;
        font-weight: 500;
    }

    .other .bubble {
        background: #222;
        color: white;
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .bubble p { margin: 0; word-break: break-word; }
    .time {
        font-size: 0.6rem;
        opacity: 0.5;
        display: block;
        margin-top: 5px;
        text-align: right;
    }

    /* Input Bereich */
    .chat-input-bar {
        padding: 15px 15px 35px; /* Viel Platz unten für mobile Home-Bar */
        background: #0a0a0a;
        border-top: 1px solid rgba(255,255,255,0.08);
    }

    #chat-form {
        display: flex;
        background: #161616;
        border-radius: 30px;
        padding: 6px 6px 6px 18px;
        align-items: center;
        border: 1px solid #252525;
    }

    #msg-input {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        font-size: 16px; /* VERHINDERT IOS ZOOM */
        padding: 10px 0;
        outline: none;
        font-family: inherit;
    }

    #send-btn {
        background: var(--cyan);
        color: black;
        border: none;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
        flex-shrink: 0;
    }
    #send-btn:hover { transform: scale(1.05); }

    .loader { display: flex; justify-content: center; padding-top: 40px; }
    .spinner { width: 20px; height: 20px; border: 2px solid #222; border-top: 2px solid var(--cyan); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>