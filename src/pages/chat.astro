---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Chat | startplatzboerse.com">
    <main class="chat-app-shell">
        <header class="chat-header">
            <a href="/dashboard" class="back-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg>
            </a>
            <div class="header-info">
                <span id="chat-event-name" class="event-tag">Event</span>
                <h2 id="chat-partner-name">Partner</h2>
            </div>
        </header>

        <div id="chat-window" class="chat-window">
            <div id="loader" class="loader"><div class="spinner"></div></div>
            </div>

        <footer class="chat-input-area">
            <form id="chat-form">
                <input 
                    type="text" 
                    id="msg-input" 
                    placeholder="Nachricht schreiben..." 
                    autocomplete="off"
                    enterkeyhint="send"
                >
                <button type="submit" id="send-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </form>
        </footer>
    </main>
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get('id');
    let currentUser = null;

    async function initChat() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return window.location.href = '/login';
        currentUser = user;

        const [infoRes, msgsRes] = await Promise.all([
            supabase.from('conversations').select('*, listings(event_name)').eq('id', conversationId).single(),
            supabase.from('messages').select('*').eq('conversation_id', conversationId).order('created_at', { ascending: true })
        ]);

        if (infoRes.data) {
            document.getElementById('chat-event-name').innerText = infoRes.data.listings?.event_name || "Event";
            document.getElementById('chat-partner-name').innerText = infoRes.data.buyer_id === user.id ? "Verkäufer" : "Käufer";
        }

        if (msgsRes.data) {
            const loader = document.getElementById('loader');
            if(loader) loader.style.display = 'none';
            msgsRes.data.forEach(msg => appendMessage(msg));
            scrollToBottom();
        }

        supabase.channel(`chat-${conversationId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `conversation_id=eq.${conversationId}` }, 
                payload => {
                    if (payload.new.sender_id !== currentUser.id) {
                        appendMessage(payload.new);
                    }
                }
            ).subscribe();
    }

    function appendMessage(msg) {
        const container = document.getElementById('chat-window');
        if (!container || document.getElementById(`msg-${msg.id}`)) return;

        // DER ID-CHECK (Sicherheits-String-Vergleich)
        const isMe = String(msg.sender_id) === String(currentUser?.id);
        
        const row = document.createElement('div');
        row.id = `msg-${msg.id || Date.now()}`;
        row.className = `msg-row ${isMe ? 'me' : 'other'}`;
        
        row.innerHTML = `
            <div class="msg-bubble">
                <p>${msg.content}</p>
            </div>
            <span class="msg-time">${msg.created_at ? new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Jetzt'}</span>
        `;
        
        container.appendChild(row);
        scrollToBottom();
    }

    function scrollToBottom() {
        const win = document.getElementById('chat-window');
        if(win) win.scrollTop = win.scrollHeight;
    }

    const form = document.getElementById('chat-form');
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;
        input.value = "";

        const { data } = await supabase.from('messages').insert({
            conversation_id: conversationId,
            sender_id: currentUser.id,
            content: text
        }).select().single();

        if (data) appendMessage(data);
    });

    // S24 KEYBOARD FIX
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const shell = document.querySelector('.chat-app-shell');
            if (shell) {
                shell.style.height = window.visualViewport.height + 'px';
                scrollToBottom();
            }
        });
    }

    initChat();
</script>

<style is:global>
    /* 1. RADIKALER RESET */
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        height: 100dvh !important;
        width: 100% !important;
        overflow: hidden !important;
        background: #000 !important;
        position: fixed;
    }

    /* 2. DAS LAYOUT (SHELL) */
    .chat-app-shell {
        display: flex;
        flex-direction: column;
        height: 100dvh;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        background: #000;
        position: relative;
        /* ABSTAND FÜR DEIN DOCK OBEN */
        padding-top: 80px; 
        box-sizing: border-box;
    }

    /* 3. HEADER & INPUT */
    .chat-header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        gap: 15px;
        background: #0a0a0a;
        border-bottom: 1px solid #1a1a1a;
    }
    .back-btn { color: #666; }
    .event-tag { font-size: 10px; color: #00bcd4; text-transform: uppercase; font-weight: 900; }
    .header-info h2 { font-size: 16px; margin: 0; color: #fff; }

    .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #000;
    }

    /* 4. DIE FARBLICHE & SEITLICHE TRENNUNG (Wichtig!) */
    .msg-row {
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
    }

    /* RECHTS (Deine Nachrichten) */
    .msg-row.me {
        align-items: flex-end !important;
    }
    .msg-row.me .msg-bubble {
        background-color: #00bcd4 !important; /* Cyan */
        color: #000000 !important;
        border-radius: 18px 18px 4px 18px !important;
    }

    /* LINKS (Andere Nachrichten) */
    .msg-row.other {
        align-items: flex-start !important;
    }
    .msg-row.other .msg-bubble {
        background-color: #262626 !important; /* Grau */
        color: #ffffff !important;
        border-radius: 18px 18px 18px 4px !important;
    }

    .msg-bubble {
        max-width: 85% !important;
        padding: 10px 14px !important;
        font-size: 15px !important;
        line-height: 1.4 !important;
    }

    .msg-time {
        font-size: 10px;
        color: #555;
        margin-top: 4px;
    }

    /* INPUT UNTEN */
    .chat-input-area {
        padding: 10px 12px 25px;
        background: #050505;
        border-top: 1px solid #1a1a1a;
    }
    #chat-form {
        display: flex;
        background: #1a1a1a;
        border-radius: 25px;
        padding: 4px 4px 4px 16px;
        align-items: center;
        border: 1px solid #333;
    }
    #msg-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 16px;
        padding: 10px 0;
        outline: none;
    }
    #send-btn {
        background: #00bcd4;
        color: #000;
        border: none;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loader { display: flex; justify-content: center; padding-top: 40px; }
    .spinner { width: 24px; height: 24px; border: 3px solid #1a1a1a; border-top: 3px solid #00bcd4; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>