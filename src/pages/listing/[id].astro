---
// 1. SSR erzwingen (WICHTIG für Vercel)
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Popup from '../../components/Popup.astro';
import { createClient } from '@supabase/supabase-js';

const { id } = Astro.params;

// Supabase initialisieren
const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

// Daten abrufen
const { data: item, error } = await supabase
  .from('listings')
  .select('*')
  .eq('id', id)
  .maybeSingle(); // Sicherer als .single()

// Falls ein Fehler passiert, loggen wir ihn für Vercel
if (error) {
  console.error("Supabase Error auf Detailseite:", error.message);
}
---

<Layout title={item ? `${item.event_name}` : "Inserat Details"}>
    <main class="listing-page">
        <div class="container">
            <a href="/" class="back-link">← Zurück zur Suche</a>

            {(!item) ? (
                <div class="error-box card">
                    <h2>Inserat nicht gefunden</h2>
                    <p>Die ID <strong>{id}</strong> konnte in der Datenbank nicht gefunden werden.</p>
                    {error && <p style="color: red;">Fehler: {error.message}</p>}
                    <a href="/" class="btn-cyan-glow" style="display:inline-block; margin-top:20px;">Zurück zur Startseite</a>
                </div>
            ) : (
                <div class="listing-layout">
                    <div class="content-side">
                        <span class="badge">{item.category}</span>
                        <h1 class="glow-title">{item.event_name}</h1>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Datum</span>
                                <span class="val">{new Date(item.event_date).toLocaleDateString('de-DE')}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Ort</span>
                                <span class="val">{item.location} {item.plz ? `(${item.plz})` : ''}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Distanz</span>
                                <span class="val">{item.distance || 'K.A.'}</span>
                            </div>
                        </div>

                        <div class="price-section">
                            <div class="price-display">
                                {item.old_price && <span class="old-price">{item.old_price}€</span>}
                                <span class="main-price">{item.price}€</span>
                            </div>
                        </div>
                    </div>

                    <aside class="sidebar">
                        <div class="card contact-card">
                            <h3>Startplatz anfragen</h3>
                            <p>Schreibe dem Verkäufer eine Nachricht:</p>
                            
                            <form id="contact-form">
                                <input type="hidden" name="listing_id" value={item.id}>
                                <input type="hidden" name="seller_id" value={item.user_id}>
                                
                                <div id="guest-fields">
                                    <input type="text" name="name" placeholder="Dein Name" class="input-field" required>
                                    <input type="email" name="email" placeholder="Deine E-Mail" class="input-field" required>
                                </div>

                                <textarea name="message" placeholder="Hallo, ich habe Interesse..." class="input-field textarea" required></textarea>
                                
                                <button type="submit" class="btn-cyan-glow" id="send-btn">Anfrage jetzt senden</button>
                            </form>
                        </div>
                    </aside>
                </div>
            )}
        </div>
    </main>
    <Footer />
</Layout>

<script>
    // Kontakt-Logik hier (identisch zu vorher, nur mit Fehler-Popups)
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(import.meta.env.PUBLIC_SUPABASE_URL, import.meta.env.PUBLIC_SUPABASE_ANON_KEY);

    const form = document.getElementById('contact-form') as HTMLFormElement;
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('send-btn') as HTMLButtonElement;
        btn.innerText = "Wird gesendet...";
        btn.disabled = true;

        const formData = new FormData(form);
        const { data: { user } } = await supabase.auth.getUser();

        const { error } = await supabase.from('inquiries').insert([{
            listing_id: formData.get('listing_id'),
            seller_id: formData.get('seller_id'),
            buyer_id: user?.id || null,
            buyer_name: formData.get('name'),
            buyer_email: formData.get('email'),
            message: formData.get('message')
        }]);

        if (error) {
            alert("Fehler: " + error.message);
            btn.disabled = false;
            btn.innerText = "Anfrage jetzt senden";
        } else {
            alert("Anfrage erfolgreich gesendet!");
            form.reset();
            btn.innerText = "Gesendet!";
        }
    });
</script>

<style>
    .listing-page { background: #050505; min-height: 100vh; padding: 140px 20px 80px; color: white; }
    .container { max-width: 1100px; margin: 0 auto; }
    
    .listing-layout { display: grid; grid-template-columns: 1fr 380px; gap: 40px; margin-top: 30px; }
    
    .glow-title { font-size: clamp(2.5rem, 6vw, 4.5rem); font-weight: 900; margin: 15px 0; letter-spacing: -2px; line-height: 1; }
    .badge { color: #00bcd4; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; }
    
    .info-grid { display: flex; gap: 40px; margin: 40px 0; padding: 30px 0; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a; }
    .info-item { display: flex; flex-direction: column; }
    .label { color: #444; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
    .val { font-size: 1.2rem; font-weight: 700; }

    .price-display { display: flex; align-items: baseline; gap: 20px; }
    .main-price { font-size: 4rem; font-weight: 900; color: #00bcd4; }
    .old-price { font-size: 1.8rem; color: #333; text-decoration: line-through; }

    .card { background: #111; border: 1px solid #222; border-radius: 24px; padding: 30px; }
    .contact-card h3 { margin-bottom: 10px; font-weight: 800; }
    .contact-card p { color: #666; font-size: 0.9rem; margin-bottom: 25px; }

    .input-field { width: 100%; background: #000; border: 1px solid #222; padding: 15px; border-radius: 12px; color: white; margin-bottom: 12px; font-family: inherit; }
    .textarea { height: 120px; resize: none; }
    
    .btn-cyan-glow { width: 100%; background: #00bcd4; color: black; border: none; padding: 18px; border-radius: 16px; font-weight: 900; cursor: pointer; transition: 0.3s; }
    .btn-cyan-glow:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0, 188, 212, 0.3); }

    .back-link { color: #444; text-decoration: none; font-weight: 700; font-size: 0.9rem; }
    .back-link:hover { color: #00bcd4; }

    @media (max-width: 900px) {
        .listing-layout { grid-template-columns: 1fr; }
        .sidebar { order: -1; } /* Formular oben auf Mobile */
    }
</style>