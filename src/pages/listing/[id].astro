---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro'; 
import { createClient } from '@supabase/supabase-js';

const { id } = Astro.params;
const { searchParams } = Astro.url;
const origin = searchParams.get('from'); // Erkennt 'index' oder 'search'

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

const { data: item, error } = await supabase
  .from('listings')
  .select('*')
  .eq('id', id)
  .maybeSingle();

if (error) {
  console.error("Supabase Error:", error.message);
}

// Dynamischer Text f√ºr den Button
const backLabel = origin === 'search' ? "‚Üê Zur√ºck zur Suche" : "‚Üê Zur√ºck zur √úbersicht";
---

<Layout title={item ? item.event_name : "Details"}>
    <main class="listing-page">
        <div class="container">
            <button id="dynamic-back-btn" class="back-link">
                {backLabel}
            </button>

            {!item ? (
                <div class="error-box card">
                    <h2>Inserat nicht gefunden</h2>
                    <p>Das Inserat existiert nicht oder wurde gel√∂scht.</p>
                    <a href="/" class="btn-cyan-glow" style="display:inline-block; margin-top:20px;">Startseite</a>
                </div>
            ) : (
                <div class="listing-layout">
                    
                    <div class="content-side">
                        <span class="badge">{item.category}</span>
                        <h1 class="glow-title">{item.event_name}</h1>
                        
                        <div class="price-section mobile-only">
                             <span class="main-price">{item.price}‚Ç¨</span>
                             {item.old_price && <span class="old-price">{item.old_price}‚Ç¨</span>}
                        </div>

                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Datum</span>
                                <span class="val">{new Date(item.event_date).toLocaleDateString('de-DE')}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Ort</span>
                                <span class="val">{item.location} {item.plz ? `(${item.plz})` : ''}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Distanz</span>
                                <span class="val">{item.distance || 'K.A.'}</span>
                            </div>
                        </div>

                        <div class="price-section desktop-only">
                            <div class="price-display">
                                {item.old_price && <span class="old-price">{item.old_price}‚Ç¨</span>}
                                <span class="main-price">{item.price}‚Ç¨</span>
                            </div>
                        </div>

                        <div class="description-box">
                            <span class="label">Zusatzinfos</span>
                            <p>{item.description || 'Keine weiteren Details vom Verk√§ufer hinterlegt.'}</p>
                        </div>
                    </div>

                    <aside class="sidebar">
                        <div class="card contact-card">
                            <h3>Verk√§ufer kontaktieren</h3>
                            <p>Sende eine Nachricht, um Details oder die √úbergabe zu kl√§ren.</p>
                            
                            <form id="contact-form">
                                <input type="hidden" name="listing_id" value={item.id}>
                                <input type="hidden" name="seller_id" value={item.user_id}>
                                
                                <textarea name="message" placeholder="Hallo, ich habe Interesse an deinem Startplatz..." class="input-field textarea" required></textarea>
                                
                                <button type="submit" class="btn-cyan-glow" id="send-btn">Nachricht senden</button>
                            </form>
                            <p class="login-hint">üîí Sicherer Chat via Startplatzb√∂rse</p>
                        </div>
                    </aside>
                </div>
            )}
        </div>
    </main>
    
    <Footer /> 
</Layout>

<script>
    import { createClient } from '@supabase/supabase-js';

    // BACK-LOGIK
    const backBtn = document.getElementById('dynamic-back-btn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const origin = urlParams.get('from');

            if (origin === 'search') {
                if (window.history.length > 1) {
                    window.history.back(); // Beh√§lt Filter in der Suche
                } else {
                    window.location.href = '/suche';
                }
            } else {
                window.location.href = '/';
            }
        });
    }

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL, 
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
    );

    const form = document.getElementById('contact-form');
    
    // Draft wiederherstellen
    document.addEventListener('DOMContentLoaded', () => {
        const savedDraft = localStorage.getItem('draft_msg');
        const textArea = document.querySelector('textarea[name="message"]');
        if (savedDraft && textArea && (textArea as HTMLTextAreaElement).value === "") {
            (textArea as HTMLTextAreaElement).value = savedDraft;
        }
    });

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('send-btn') as HTMLButtonElement;
            const originalText = btn.innerText;
            btn.innerText = "Pr√ºfe...";
            btn.disabled = true;

            const formData = new FormData(form as HTMLFormElement);
            const messageText = formData.get('message');
            const listingId = formData.get('listing_id');
            const sellerId = formData.get('seller_id');

            try {
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    localStorage.setItem('draft_msg', messageText as string);
                    window.location.href = `/login?redirect=/listing/${listingId}`;
                    return; 
                }

                if (user.id === sellerId) {
                    alert("Du kannst dir nicht selbst schreiben.");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                const { data: existing } = await supabase
                    .from('conversations')
                    .select('id')
                    .eq('listing_id', listingId)
                    .eq('buyer_id', user.id)
                    .single();

                let chatId = existing?.id;

                if (!chatId) {
                    const { data: nc, error: ne } = await supabase
                        .from('conversations')
                        .insert({ listing_id: listingId, buyer_id: user.id, seller_id: sellerId })
                        .select().single();
                    if (ne) throw ne;
                    chatId = nc.id;
                }

                const { error: me } = await supabase.from('messages').insert({
                    conversation_id: chatId,
                    sender_id: user.id,
                    content: messageText
                });

                if (me) throw me;
                localStorage.removeItem('draft_msg');
                window.location.href = `/dashboard?chat_id=${chatId}`;

            } catch (err) {
                console.error(err);
                alert("Fehler beim Senden.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }); 
    }
</script>

<style>
    :root {
        --cyan: #00bcd4;
        --bg: #323232;
        --card: #111;
        --border: #222;
    }

    /* PFEILE IN NUMMERNFELDERN ENTFERNEN */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .listing-page { 
        background: var(--bg); 
        min-height: 100vh; 
        padding: 100px 15px 60px; 
        color: white; 
    }
    
    .container { 
    max-width: 1100px; 
    margin: 0 auto;
    }
    
    .listing-layout { 
        display: grid; 
        grid-template-columns: 1fr;
        gap: 30px; 
        margin-top: 20px; 
    }
    
    @media (min-width: 992px) {
        .listing-layout { grid-template-columns: 1fr 380px; gap: 60px; }
        .listing-page { padding: 160px 20px 80px; } /* Mehr Abstand Desktop */
    }

    .glow-title { 
        font-size: 2.2rem;
        font-weight: 900; 
        margin: 10px 0; 
        line-height: 1.1; 
    }

    @media (min-width: 768px) {
        .glow-title { font-size: 3.5rem; }
    }

    .badge { color: var(--cyan); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 0.7rem; }
    
    .info-grid { 
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px; 
        margin: 25px 0; 
        padding: 20px 0; 
        border-top: 1px solid #1a1a1a; 
        border-bottom: 1px solid #1a1a1a; 
    }

    @media (min-width: 768px) {
        .info-grid { display: flex; gap: 40px; }
    }

    .label { color: #555; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block;}
    .val { font-size: 1rem; font-weight: 700; }

    .price-section { margin: 15px 0; display: flex; align-items: baseline; gap: 15px; }
    .main-price { font-size: 2.5rem; font-weight: 900; color: var(--cyan); }
    .old-price { font-size: 1.2rem; color: #333; text-decoration: line-through; }

    .mobile-only { display: flex; }
    .desktop-only { display: none; }

    @media (min-width: 992px) {
        .mobile-only { display: none; }
        .desktop-only { display: flex; }
        .main-price { font-size: 3.5rem; }
    }

    .description-box { 
    margin: 20px 0; 
    line-height: 1.6; 
    color: #aaa;
    }

    .card { background: var(--card); border: 5px solid var(--border); border-radius: 24px; padding: 25px; }
    .contact-card h3 { margin-bottom: 8px; font-weight: 800; font-size: 1.2rem; }
    .contact-card p { color: #666; font-size: 0.85rem; margin-bottom: 20px; }
    .login-hint { font-size: 0.7rem; text-align: center; margin-top: 15px; color: #333; font-weight: 600; }

    .input-field { width: 100%; background: #000; border: 1px solid #222; padding: 15px; border-radius: 12px; color: white; margin-bottom: 12px; font-family: inherit; font-size: 1rem; }
    .textarea { height: 110px; resize: none; }
    
    .btn-cyan-glow { width: 100%; background: var(--cyan); color: black; border: none; padding: 16px; border-radius: 14px; font-weight: 900; cursor: pointer; transition: 0.3s; font-size: 1rem; }
    .btn-cyan-glow:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 188, 212, 0.2); }

    .back-link { 
        background: transparent;
        border: none;
        color: #555; 
        text-decoration: none; 
        font-weight: 700; 
        font-size: 0.8rem; 
        margin-bottom: 15px; 
        display: inline-block; 
        cursor: pointer;
        padding: 0;
    }
    .back-link:hover { color: white; }
</style>